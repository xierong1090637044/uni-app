(my["webpackJsonp"]=my["webpackJsonp"]||[]).push([["pages/common/good_allocation/allocation_detail/allocation_detail"],{"0fe6":function(e,t,o){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,s,u=a(o("9546")),n=a(o("7fd5")),d=(a(o("9f50")),a(o("856d")));a(o("a2fc"));function a(e){return e&&e.__esModule?e:{default:e}}function c(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=l(e))){var t=0,o=function(){};return{s:o,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s,u=!0,n=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return u=e.done,e},e:function(e){n=!0,s=e},f:function(){try{u||null==r.return||r.return()}finally{if(n)throw s}}}}function l(e,t){if(e){if("string"===typeof e)return i(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(o):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?i(e,t):void 0}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}var m=[],f={data:function(){return{products:[],stock:"",out_stock:"",button_disabled:!1,beizhu_text:"",out_products:[],all_money:0,real_money:0,total_num:0,nowDay:n.default.getDay(0,!0)}},onLoad:function(){s=this,r=e.getStorageSync("uid"),this.products=e.getStorageSync("products");for(var t=0;t<this.products.length;t++)this.all_money=Number((this.products[t].total_money+this.all_money).toFixed(2)),this.total_num+=Number(this.products[t].num);this.real_money=Number(this.all_money.toFixed(2))},onShow:function(){s.out_stock=e.getStorageSync("out_warehouse")?e.getStorageSync("out_warehouse")[0].stock:""},methods:{formSubmit:function(t){if(this.button_disabled=!0,""==s.out_stock||null==s.out_stock)return e.showToast({title:"请选择调入店仓",icon:"none"}),void(this.button_disabled=!1);s.unique(s.products),s.addTbRecord(t)},unique:function(t){for(var o=[t[0]],r=1;r<t.length;r++){for(var u=!1,n=0;n<o.length;n++)if(t[r].header.objectId===o[n].header.objectId){if(t[r].selected_model){var d,a=c(t[r].selected_model);try{for(a.s();!(d=a.n()).done;){var l,i=d.value,f=c(o[n].selected_model);try{for(f.s();!(l=f.n()).done;){var v=l.value;v.id==i.id&&(v.num+=Number(i.num))}}catch(g){f.e(g)}finally{f.f()}}}catch(g){a.e(g)}finally{a.f()}}o[n].num+=t[r].num,u=!0}u||o.push(t[r])}console.log(o),s.products=e.getStorageSync("products"),m=o},addTbRecord:function(t){var o,d=this;e.showLoading({title:"请勿退出..."});for(var a=u.default.Pointer("stocks"),l=a.set(s.out_stock.objectId),i=new Array,f=[],v=function(t){var n=u.default.Pointer("stocks");o=n.set(d.products[t].stocks.objectId);var a=u.default.Query("Bills"),m={},v=u.default.Pointer("_User"),g=v.set(r),p=u.default.Pointer("_User"),_=p.set(e.getStorageSync("masterId")),b=u.default.Pointer("Goods"),h=b.set(d.products[t].objectId);a.set("goodsName",d.products[t].goodsName),a.set("retailPrice",d.products[t].modify_retailPrice),a.set("num",Number(d.products[t].num)),a.set("total_money",Number(d.products[t].total_money)),a.set("goodsId",h),a.set("userId",g),a.set("type",-2),a.set("opreater",_),a.set("stock",o),a.set("out_stock",l);var y={};m.goodsName=d.products[t].goodsName,m.stock=d.products[t].stocks.stock_name,m.out_stock=s.out_stock.stock_name,m.reserve=d.products[t].reserve,y.objectId=d.products[t].objectId,d.products[t].selectd_model&&(y.selected_model=d.products[t].selected_model,y.models=d.products[t].models),m.goodsId=y,m.num=Number(d.products[t].num),m.type=-2,i.push(a),f.push(m);var S=u.default.Query("Goods");S.get(s.products[t].objectId).then((function(e){var o=Number(d.products[t].reserve)-Number(d.products[t].num);if(d.products[t].selected_model){var r,s=c(d.products[t].selected_model);try{for(s.s();!(r=s.n()).done;){var u,n=r.value,a=c(d.products[t].models);try{for(a.s();!(u=a.n()).done;){var l=u.value;l.id==n.id&&(l.reserve=Number(l.reserve)-Number(n.num)),delete l.num}}catch(i){a.e(i)}finally{a.f()}}}catch(i){s.e(i)}finally{s.f()}e.set("models",d.products[t].models)}e.set("reserve",o),e.save()}))},g=0;g<s.products.length;g++)v(g);u.default.Query("Bills").saveAll(i).then((function(d){for(var a=[],i=0;i<d.length;i++)a.push(d[i].success.objectId);var v=u.default.Pointer("_User"),g=v.set(r),p=e.getStorageSync("masterId"),_=u.default.Pointer("_User"),b=_.set(p),h=u.default.Query("order_opreations");h.set("detail",f),h.set("bills",a),h.set("beizhu",t.detail.value.input_beizhu),h.set("type",-2),h.set("opreater",b),h.set("stock",o),h.set("out_stock",l),h.set("master",g),h.set("goodsName",s.products[0].goodsName),h.save().then((function(t){t.objectId;e.hideLoading(),s.button_disabled=!1,e.setStorageSync("is_option",!0);for(var o=function(t){var o=u.default.Query("Goods");o.equalTo("goodsName","==",m[t].goodsName),o.equalTo("userId","==",r),o.equalTo("stocks","==",s.out_stock.objectId),o.find().then((function(r){var u=r;0==u.length?n.default.upload_good_withNoCan(m[t],s.out_stock,Number(m[t].num),"allocation").then((function(o){t==m.length-1&&(e.hideLoading(),e.removeStorageSync("warehouse"),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),e.showToast({title:"调拨成功"}),setTimeout((function(){e.navigateBack({delta:2})}),500))})):o.get(u[0].objectId).then((function(o){if(m[t].selected_model){var r,s=c(m[t].selected_model);try{for(s.s();!(r=s.n()).done;){var n,d=r.value,a=c(u[0].models);try{for(a.s();!(n=a.n()).done;){var l=n.value;l.id==d.id&&(l.reserve=Number(l.reserve)+Number(d.num)),delete l.num}}catch(i){a.e(i)}finally{a.f()}}}catch(i){s.e(i)}finally{s.f()}o.set("models",u[0].models)}o.set("reserve",Number(u[0].reserve)+Number(m[t].num)),o.save(),t==m.length-1&&(e.hideLoading(),e.removeStorageSync("warehouse"),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),e.showToast({title:"调拨成功"}),setTimeout((function(){e.navigateBack({delta:2})}),500))}))}))},d=0;d<m.length;d++)o(d)}))}),(function(e){console.log("异常处理")}))},add_tb_record:function(t){var o=this;e.showLoading({title:"上传中..."});for(var a,l=u.default.Pointer("stocks"),i=l.set(s.out_stock.objectId),m=new Array,f=[],v=function(v){a=l.set(o.products[v].stocks.objectId);var g=u.default.Query("Goods");g.equalTo("goodsName","==",s.products[v].goodsName),g.equalTo("userId","==",r),g.equalTo("stocks","==",s.out_stock.objectId),g.find().then((function(l){console.log(l);var g,p,_=[];if(0==l.length){if(s.products[v].selectd_model)return e.showToast({icon:"none",title:"此多规格产品未关联到此店仓"}),void(o.button_disabled=!1);n.default.upload_good_withNoCan(s.products[v],s.out_stock,Number(o.products[v].num),"allocation").then((function(c){console.log(c);var l={};l.objectId=c[1].objectId,l.reserve=Number(o.products[v].num),_[0]=l,g=Number(o.products[v].reserve)-Number(o.products[v].num),p=Number(o.products[v].num);var b=u.default.Query("Goods");b.get(s.products[v].objectId).then((function(e){e.set("reserve",g),e.save(),b.get(_[0].objectId).then((function(e){e.set("reserve",p),e.save()}))}));var h=u.default.Query("Bills"),y={},S=u.default.Pointer("_User"),N=S.set(r),k=u.default.Pointer("_User"),I=k.set(e.getStorageSync("masterId")),j=u.default.Pointer("Goods"),w=j.set(o.products[v].objectId);h.set("goodsName",o.products[v].goodsName),h.set("retailPrice",o.products[v].modify_retailPrice),h.set("num",Number(o.products[v].num)),h.set("total_money",Number(o.products[v].total_money)),h.set("goodsId",w),h.set("userId",N),h.set("type",-2),h.set("opreater",I),h.set("stock",a),h.set("out_stock",i);var P={};y.goodsName=o.products[v].goodsName,y.stock=o.products[v].stocks.stock_name,y.out_stock=s.out_stock.stock_name,y.reserve=o.products[v].reserve,y.out_reserve=_[0].reserve,P.objectId=o.products[v].objectId,P.out_objectId=_[0].objectId,P.reserve=g,P.out_reserve=p,o.products[v].selectd_model&&(P.selected_model=o.products[v].selected_model,P.models=o.products[v].models),y.goodsId=P,y.num=Number(o.products[v].num),y.type=-2,m.push(h),f.push(y),v==o.products.length-1&&u.default.Query("Bills").saveAll(m).then((function(o){for(var c=[],l=0;l<o.length;l++)c.push(o[l].success.objectId);var m=u.default.Pointer("_User"),v=m.set(r),g=e.getStorageSync("masterId"),p=u.default.Pointer("_User"),_=p.set(g),b=u.default.Query("order_opreations");b.set("detail",f),b.set("bills",c),b.set("beizhu",t.detail.value.input_beizhu),b.set("type",-2),b.set("opreater",_),b.set("stock",a),b.set("out_stock",i),b.set("master",v),b.set("goodsName",s.products[0].goodsName),b.save().then((function(t){var o=t.objectId;e.hideLoading(),e.showToast({title:"产品调拨成功",icon:"success",success:function(){s.button_disabled=!1,e.setStorageSync("is_option",!0),setTimeout((function(){e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),n.default.log(e.getStorageSync("user").nickName+"调拨了'"+s.products[0].goodsName+"'等"+s.products.length+"商品",-2,t.objectId),e.getStorageSync("setting").auto_print&&d.default.autoPrint(o),e.navigateBack({delta:2})}),500)}})}))}),(function(e){console.log("异常处理")}))}))}else{if(_=l,g=Number(o.products[v].reserve)-Number(o.products[v].num),p=Number(_[0].reserve)+Number(o.products[v].num),o.products[v].stocks.objectId!=s.out_stock.objectId){var b=u.default.Query("Goods");b.get(_[0].objectId).then((function(e){console.log(e);var t=e;if(o.products[v].selectd_model){var r,u=c(o.products[v].selected_model);try{for(u.s();!(r=u.n()).done;){var n,d=r.value,a=c(t.models);try{for(a.s();!(n=a.n()).done;){var l=n.value;l.id==d.id&&(l.reserve=Number(l.reserve)+Number(d.num)),delete l.num}}catch(i){a.e(i)}finally{a.f()}}}catch(i){u.e(i)}finally{u.f()}e.set("models",t.models)}e.set("reserve",p),e.save(),b.get(s.products[v].objectId).then((function(e){if(o.products[v].selectd_model){var t,r=c(o.products[v].selected_model);try{for(r.s();!(t=r.n()).done;){var s,u=t.value,n=c(o.products[v].models);try{for(n.s();!(s=n.n()).done;){var d=s.value;d.id==u.id&&(d.reserve=Number(d.reserve)-Number(u.num)),delete d.num}}catch(i){n.e(i)}finally{n.f()}}}catch(i){r.e(i)}finally{r.f()}e.set("models",o.products[v].models)}e.set("reserve",g),e.save()}))}))}var h=u.default.Query("Bills"),y={},S=u.default.Pointer("_User"),N=S.set(r),k=u.default.Pointer("_User"),I=k.set(e.getStorageSync("masterId")),j=u.default.Pointer("Goods"),w=j.set(o.products[v].objectId);h.set("goodsName",o.products[v].goodsName),h.set("num",Number(o.products[v].num)),h.set("goodsId",w),h.set("userId",N),h.set("type",-2),h.set("opreater",I),h.set("stock",a),h.set("out_stock",i);var P={};y.goodsName=o.products[v].goodsName,y.stock=o.products[v].stocks.stock_name,y.out_stock=s.out_stock.stock_name,y.reserve=o.products[v].reserve,y.out_reserve=_[0].reserve,P.objectId=o.products[v].objectId,P.out_objectId=_[0].objectId,P.reserve=g,P.out_reserve=p,o.products[v].selectd_model&&(P.selected_model=o.products[v].selected_model,P.models=o.products[v].models),y.goodsId=P,y.num=Number(o.products[v].num),y.type=-2,m.push(h),f.push(y),v==o.products.length-1&&u.default.Query("Bills").saveAll(m).then((function(o){for(var c=[],l=0;l<o.length;l++)c.push(o[l].success.objectId);var m=u.default.Pointer("_User"),v=m.set(r),g=e.getStorageSync("masterId"),p=u.default.Pointer("_User"),_=p.set(g),b=u.default.Query("order_opreations");b.set("detail",f),b.set("bills",c),b.set("beizhu",t.detail.value.input_beizhu),b.set("type",-2),b.set("opreater",_),b.set("stock",a),b.set("out_stock",i),b.set("master",v),b.set("goodsName",s.products[0].goodsName),b.save().then((function(t){var o=t.objectId;e.showToast({title:"产品调拨成功",icon:"success",success:function(){e.hideLoading(),e.setStorageSync("is_option",!0),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),setTimeout((function(){s.button_disabled=!1,n.default.log(e.getStorageSync("user").nickName+"调拨了'"+s.products[0].goodsName+"'等"+s.products.length+"商品",-2,t.objectId),e.getStorageSync("setting").auto_print&&d.default.autoPrint(o),e.navigateBack({delta:2})}),500)}})}))}),(function(e){console.log("异常处理")}))}}))},g=0;g<this.products.length;g++)v(g)}}};t.default=f}).call(this,o("c11b")["default"])},"3eb6":function(e,t,o){},"49e6":function(e,t,o){"use strict";var r=o("3eb6"),s=o.n(r);s.a},"64a8":function(e,t,o){"use strict";o.r(t);var r=o("dab7"),s=o("f43f");for(var u in s)"default"!==u&&function(e){o.d(t,e,(function(){return s[e]}))}(u);o("49e6");var n,d=o("f0c5"),a=Object(d["a"])(s["default"],r["b"],r["c"],!1,null,null,null,!1,r["a"],n);t["default"]=a.exports},dab7:function(e,t,o){"use strict";var r,s=function(){var e=this,t=e.$createElement,o=(e._self._c,e.nowDay.split(" "));e.$mp.data=Object.assign({},{$root:{g0:o}})},u=[];o.d(t,"b",(function(){return s})),o.d(t,"c",(function(){return u})),o.d(t,"a",(function(){return r}))},f43f:function(e,t,o){"use strict";o.r(t);var r=o("0fe6"),s=o.n(r);for(var u in r)"default"!==u&&function(e){o.d(t,e,(function(){return r[e]}))}(u);t["default"]=s.a},fb19:function(e,t,o){"use strict";(function(e){o("d510"),o("921b");r(o("66fd"));var t=r(o("64a8"));function r(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,o("c11b")["createPage"])}},[["fb19","common/runtime","common/vendor"]]]);