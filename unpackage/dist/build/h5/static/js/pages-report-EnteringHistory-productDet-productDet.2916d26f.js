(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-report-EnteringHistory-productDet-productDet"],{"1f893":function(t,e,i){var a=i("aff6");"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var n=i("4f06").default;n("1e92f25c",a,!0,{sourceMap:!1,shadowMode:!1})},"31d8":function(t,e,i){"use strict";var a={"uni-nav-bar":i("96bd").default,"tki-qrcode":i("13d4").default},n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-uni-view",[t.loading?i("loading"):i("v-uni-view",{staticClass:"page"},[i("uni-nav-bar",{attrs:{fixed:!1,color:"#333333","background-color":"#FFFFFF","right-text":"操作"},on:{"click-right":function(e){arguments[0]=e=t.$handleEvent(e),t.show_options.apply(void 0,arguments)}}}),i("v-uni-scroll-view",{style:{height:1==t.detail.extra_type&&0==t.detail.status?"calc(100vh - 170rpx)":"calc(100vh - 80rpx)"},attrs:{"scroll-y":"true"}},[i("v-uni-view",{staticStyle:{"line-height":"70rpx",padding:"0 20rpx"}},[t._v("操作产品")]),i("v-uni-view",[i("v-uni-view",t._l(t.products,(function(e,a){return i("v-uni-view",{key:a,staticClass:"pro_listitem"},[i("v-uni-view",{staticClass:"pro_list_item",staticStyle:{color:"#000"}},[i("v-uni-view",[t._v("产品："+t._s(e.goodsName)),i("v-uni-text",[t._v("（成本价：￥"+t._s(e.goodsId.costPrice)+"）")])],1)],1),e.goodsId.selected_model?i("v-uni-view",t._l(e.goodsId.selected_model,(function(e,a){return e.num>0?i("v-uni-view",{key:a,staticClass:"display_flex_bet"},[i("v-uni-view",{staticStyle:{"font-size":"24rpx",color:"#999"}},[t._v(t._s(e.custom1.value+e.custom2.value+e.custom3.value+e.custom4.value))]),i("v-uni-view",{staticStyle:{"font-size":"24rpx",color:"#f30"}},[t._v(t._s(e.num))])],1):t._e()})),1):t._e(),i("v-uni-view",{staticClass:"pro_list"},[i("v-uni-view",[t._v("建议零售价：￥"+t._s(e.goodsId.retailPrice))]),i("v-uni-view",[t.user.rights&&"0"!=t.user.rights.othercurrent[0]?i("v-uni-text",[t._v("实际进货价：￥0（X"+t._s(e.num)+"）")]):i("v-uni-text",[t._v("实际进货价：￥"+t._s(e.modify_retailPrice)+"（X"+t._s(e.num)+"）")])],1)],1)],1)})),1),i("v-uni-view",{staticClass:"pro_allmoney"},[t._v("生产总数："+t._s(t.detail.real_num))])],1),i("v-uni-view",[i("v-uni-view",{staticClass:"kaidanmx"},[i("v-uni-view",{staticStyle:{padding:"10rpx 30rpx"}},[t._v("记录明细")]),t.detail.custom?i("v-uni-view",{staticClass:"display_flex",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("客户姓名")]),i("v-uni-view",[t._v(t._s(t.detail.custom.custom_name))])],1):i("v-uni-view",{staticClass:"display_flex",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("未记录客户")])],1),i("v-uni-view",{staticClass:"display_flex",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("开工时间")]),i("v-uni-view",[t._v(t._s(t.detail.startDay))])],1),i("v-uni-view",{staticClass:"display_flex",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("计划完成")]),i("v-uni-view",[t._v(t._s(t.detail.endDay))])],1),i("v-uni-navigator",{staticClass:"display_flex_bet",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"},attrs:{"hover-class":"none",url:"matterDet/matterDet?id="+t.detail.objectId}},[i("v-uni-view",{staticStyle:{display:"flex"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("物料信息")]),t.detail.mattersId&&t.detail.mattersId.length>0?i("v-uni-view",[t._v(t._s(t.detail.mattersId.length))]):i("v-uni-view",{staticStyle:{color:"#FF3300"}},[t._v("未添加")])],1),i("fa-icon",{attrs:{type:"angle-right",size:"20",color:"#bba14f"}})],1),i("v-uni-view",{staticClass:"display_flex_bet",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.confrimMatter.apply(void 0,arguments)}}},[i("v-uni-view",{staticStyle:{display:"flex"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("是否领料")]),t.detail.matterStatus?i("v-uni-view",{staticStyle:{color:"#2ca879"}},[t._v("已领料")]):i("v-uni-view",{staticStyle:{color:"#FF3300"}},[t._v("未领料")])],1),i("fa-icon",{attrs:{type:"angle-right",size:"20",color:"#bba14f"}})],1),i("v-uni-view",{staticClass:"display_flex_bet",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.confrimComplete.apply(void 0,arguments)}}},[i("v-uni-view",{staticStyle:{display:"flex"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("生产状态")]),t.detail.status?i("v-uni-view",{staticStyle:{color:"#2ca879"}},[t._v("已完成")]):i("v-uni-view",{staticStyle:{color:"#FF3300"}},[t._v("未完成")])],1),i("fa-icon",{attrs:{type:"angle-right",size:"20",color:"#bba14f"}})],1),t.detail.status?i("v-uni-view",{staticClass:"display_flex_bet",staticStyle:{"border-bottom":"1rpx solid#F7F7F7"}},[i("v-uni-view",{staticStyle:{display:"flex"}},[i("v-uni-view",{staticClass:"left_content"},[t._v("已入库数")]),i("v-uni-view",{staticStyle:{color:"#FF3300"}},[t._v(t._s(t.enterNum))])],1)],1):t._e()],1)],1),i("v-uni-view",{staticClass:"detail_bottom",staticStyle:{"margin-top":"20px"}},[i("v-uni-view",{staticStyle:{display:"flex","border-bottom":"1px solid#ddd","padding-bottom":"20upx"}},[i("v-uni-view",[i("v-uni-image",{staticClass:"avatar",attrs:{src:t.detail.opreater.avatarUrl}})],1),i("v-uni-view",{staticClass:"common_style"},[t._v(t._s(t.detail.opreater.nickName))]),i("v-uni-view",{staticClass:"common_style"},[t._v("（操作者）")])],1),i("v-uni-view",{staticStyle:{"text-align":"center",padding:"20rpx 0"}},[i("tki-qrcode",{ref:"qrcode",attrs:{cid:"qrcode",val:t.detail.objectId,size:140,loadMake:!0,usingComponents:!0,unit:"rpx"},on:{result:function(e){arguments[0]=e=t.$handleEvent(e),t.qrR.apply(void 0,arguments)}}}),i("v-uni-view",{staticStyle:{color:"#333333","font-weight":"bold"}},[t._v("生产单二维码")])],1),i("v-uni-view",{staticStyle:{padding:"20rpx 0 0"}},[t.detail.beizhu?i("v-uni-view",[t._v("备注："+t._s(t.detail.beizhu))]):i("v-uni-view",[t._v("备注：暂无")]),i("v-uni-view",[t._v("操作时间："+t._s(t.detail.createdAt))]),t.detail.Images&&t.detail.Images.length>0?i("v-uni-view",[i("v-uni-view",{staticClass:"notice_text"},[t._v("生产图")]),i("v-uni-view",{staticStyle:{width:"100%",padding:"20rpx 0"}},[i("v-uni-view",{staticClass:"upload_image display_flex"},t._l(t.detail.Images,(function(e,a){return i("v-uni-view",{key:a,staticStyle:{position:"relative"},on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.priview(e)}}},[i("v-uni-image",{staticStyle:{width:"180rpx",height:"180rpx","margin-right":"10rpx"},attrs:{src:e}})],1)})),1)],1)],1):t._e()],1)],1)],1)],1)],1)},o=[];i.d(e,"b",(function(){return n})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){return a}))},6320:function(t,e,i){"use strict";(function(t){var a=i("ee27");i("7db0"),i("a9e3"),i("b6802"),i("d3b7"),i("25f0"),Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n,o,s=a(i("54f8")),r=a(i("9546")),l=(a(i("856d")),a(i("7fd5"))),d=a(i("13d4")),c=a(i("120a")),u=a(i("96bd")),v={components:{tkiQrcode:d.default,loading:c.default,uniNavBar:u.default},data:function(){return{user:uni.getStorageSync("user"),identity:uni.getStorageSync("identity"),othercurrent:"",bills:[],loading:!0,products:null,detail:null,matters:[],all_money:0,really_total_money:0,real_money:0,enterNum:0}},onLoad:function(e){t.log(e),n=this,o=e.id,n.user.rights&&n.user.rights.othercurrent&&(n.othercurrent=n.user.rights.othercurrent)},onShow:function(){n.getdetail(o)},methods:{show_options:function(){uni.showActionSheet({itemList:["领料","生产完成","入库"],success:function(t){var e=t.tapIndex;0==e?n.confrimMatter():1==e?n.confrimComplete():2==e&&n.confrimEnter()},fail:function(e){t.log(e.errMsg)}})},confrimEnter:function(){if(0==n.detail.status)uni.showToast({icon:"none",title:"未生产完成！"});else if(0==n.detail.matterStatus)uni.showToast({icon:"none",title:"未领料！"});else if(n.enterNum==n.detail.real_num)uni.showToast({icon:"none",title:"已经全部入库了！"});else{var e,i=[],a=(0,s.default)(n.detail.detail);try{for(a.s();!(e=a.n()).done;){var l=e.value;i.push(l.goodsId.objectId)}}catch(c){a.e(c)}finally{a.f()}var d=r.default.Query("Goods");d.containedIn("objectId",i),d.find().then((function(e){var i,a=(0,s.default)(e);try{for(a.s();!(i=a.n()).done;){var r,l=i.value,d=(0,s.default)(n.detail.detail);try{for(d.s();!(r=d.n()).done;){var u=r.value;u.goodsId.objectId==l.objectId&&(u.enterNum?l.num=u.num-u.enterNum:l.num=u.num,l.total_money=u.num*l.costPrice,l.really_total_money=u.num*l.costPrice,l.modify_retailPrice=l.costPrice)}}catch(c){d.e(c)}finally{d.f()}}}catch(c){a.e(c)}finally{a.f()}t.log(e),uni.setStorageSync("products",e),uni.setStorageSync("detailBills",n.detail.detail),uni.navigateTo({url:"/pages/report/EnteringHistory/productDet/productEnter/productEnter?id="+o})}))}},confrimComplete:function(){uni.showModal({title:"提示",content:"是否确认生产完成",success:function(t){if(t.confirm)if(n.detail.status)uni.showToast({title:"已经生产完成！"});else{uni.showLoading({title:"生产中..."});var e=r.default.Query("order_opreations");e.set("id",o),e.set("status",!0),e.save().then((function(t){var e=r.default.Query("Bills");e.containedIn("objectId",n.detail.bills),e.find().then((function(t){t.set("status",!0),t.saveAll().then((function(t){uni.showToast({title:"生产完成"}),n.getdetail(o)}))}))}))}}})},confrimMatter:function(){n.detail.mattersId&&n.detail.mattersId.length>0?uni.showModal({title:"是否确认领料",content:"领料后不可修改",success:function(e){if(e.confirm)if(n.detail.matterStatus)uni.showToast({title:"已经领过物料！"});else{for(var i=new Array,a=[],s=uni.getStorageSync("uid"),d=0,c=0;c<n.matters.length;c++){var u=Number(n.matters[c].reserve)-n.matters[c].num;d+=n.matters[c].num;var v={},f=r.default.Query("Bills"),m=r.default.Pointer("_User"),_=m.set(s),y=r.default.Pointer("Matters"),p=y.set(n.matters[c].objectId),g=uni.getStorageSync("masterId"),w=r.default.Pointer("_User"),b=w.set(g);f.set("goodsName",n.matters[c].goodsName),f.set("retailPrice",n.matters[c].modify_retailPrice.toString()),f.set("num",Number(n.matters[c].num)),f.set("total_money",n.matters[c].total_money),f.set("really_total_money",n.matters[c].really_total_money),f.set("mattersId",p),f.set("userId",_),f.set("opreater",b),f.set("type",6);var h={};v.goodsName=n.matters[c].goodsName,v.modify_retailPrice=n.matters[c].modify_retailPrice.toString(),v.retailPrice=n.matters[c].retailPrice,v.total_money=n.matters[c].total_money,h.costPrice=n.matters[c].costPrice,h.retailPrice=n.matters[c].retailPrice,h.objectId=n.matters[c].objectId,h.reserve=u,n.matters[c].selectd_model&&(h.selected_model=n.matters[c].selected_model,h.models=n.matters[c].models),v.goodsId=h,v.num=n.matters[c].num,v.type=6,i.push(f),a.push(v)}r.default.Query("Bills").saveAll(i).then((function(e){for(var i=[],c=0;c<e.length;c++)i.push(e[c].success.objectId);var u=r.default.Pointer("_User"),v=u.set(s),f=uni.getStorageSync("masterId"),m=r.default.Pointer("_User"),_=m.set(f),y=r.default.Query("order_opreations");y.set("detail",a),y.set("real_num",d),y.set("type",6),y.set("bills",i),y.set("opreater",_),y.set("master",v),y.set("goodsName",n.matters[0].goodsName),y.set("all_money",n.all_money),y.save().then((function(e){var i=e.objectId;uni.hideLoading();var a=r.default.Query("order_opreations");a.set("id",o),a.set("matterStatus",!0),a.save().then((function(t){uni.showToast({title:"领料成功",icon:"success",duration:1e3,complete:function(){n.outRedGoodNum(n.matters).then((function(t){l.default.log(uni.getStorageSync("user").nickName+"确认领了'"+n.matters[0].goodsName+"'等"+n.matters.length+"物料",6,i),uni.setStorageSync("is_option",!0),uni.removeStorageSync("_warehouse"),uni.removeStorageSync("out_warehouse"),uni.removeStorageSync("category"),uni.removeStorageSync("warehouse"),n.getdetail(o)}))}})})).catch((function(e){t.log(e)}))}))}))}else e.cancel&&t.log("用户点击取消")}}):uni.showToast({title:"请先添加物料",icon:"none"})},outRedGoodNum:function(e){return new Promise((function(i,a){for(var n=function(a){var n=0,o=r.default.Query("Matters");o.get(e[a].objectId).then((function(t){n=Number(e[a].reserve)-Number(e[a].num),t.set("reserve",n),t.set("stocktype",n>=e[a].warning_num?1:0),t.save(),e[a].warning_num>=n&&l.default.log(e[a].goodsName+"在生产时领了"+e[a].num+"件，已经低于预警数量"+e[a].warning_num,-2,e[a].objectId),a==e.length-1&&i(!0)})).catch((function(e){t.log(e)}))},o=0;o<e.length;o++)n(o)}))},priview:function(t){uni.previewImage({current:t,urls:n.detail.Images})},getdetail:function(e){var i=this,a=r.default.Query("order_opreations");a.include("opreater","custom","producer","stock"),a.get(e).then((function(e){if(t.log(e),e.startDay&&(e.startDay=l.default.js_date_time(e.startDay)),e.endDay&&(e.endDay=l.default.js_date_time(e.endDay)),n.detail=e,n.products=e.detail,n.bills=e.bills,e.mattersId&&e.mattersId.length>0){n.matters=e.mattersId;for(var a=0;a<i.matters.length;a++)i.all_money=Number((i.matters[a].total_money+i.all_money).toFixed(2)),i.really_total_money=Number((i.matters[a].really_total_money+i.really_total_money).toFixed(2)),i.total_num+=Number(i.matters[a].num);i.real_money=Number(i.all_money.toFixed(2))}var o,r=(0,s.default)(e.detail);try{for(r.s();!(o=r.n()).done;){var d=o.value;d.enterNum&&(n.enterNum+=d.enterNum)}}catch(c){r.e(c)}finally{r.f()}n.loading=!1})).catch((function(e){t.log(e)}))},qrR:function(t){this.src=t},bcR:function(t){this.src=t},saveBccode:function(){this.$refs.barcode._saveCode()},saveQrcode:function(){this.$refs.qrcode._saveCode()}}};e.default=v}).call(this,i("5a52")["default"])},9529:function(t,e,i){"use strict";var a=i("1f893"),n=i.n(a);n.a},aab3:function(t,e,i){"use strict";i.r(e);var a=i("31d8"),n=i("fae4");for(var o in n)"default"!==o&&function(t){i.d(e,t,(function(){return n[t]}))}(o);i("9529");var s,r=i("f0c5"),l=Object(r["a"])(n["default"],a["b"],a["c"],!1,null,"0040511e",null,!1,a["a"],s);e["default"]=l.exports},aff6:function(t,e,i){var a=i("24fb");e=a(!1),e.push([t.i,".page[data-v-0040511e]{color:#4d4d4d;height:100vh;overflow-y:scroll;background:#fafafa;font-size:%?28?%}.operater_status[data-v-0040511e]{position:fixed;bottom:0;left:0;width:100%;padding:%?20?% 0;background:#b82626;color:#fff;z-index:100;text-align:center}.pro_list[data-v-0040511e]{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between}.pro_listitem[data-v-0040511e]{background-color:#fff;padding:%?10?% %?20?%;border-bottom:%?1?% solid#ddd}.pro_allmoney[data-v-0040511e]{background-color:#fff;padding:%?10?% %?20?%;text-align:right;font-size:%?32?%;color:#f30}.beizhu_style[data-v-0040511e]{width:100%;background-color:#fff;padding:%?20?%;font-size:%?32?%}.confrim_button[data-v-0040511e]{width:60%;background:#426ab3;color:#fff;font-size:%?32?%;margin:10% 20%}.detail_bottom[data-v-0040511e]{width:calc(100% - %?40?%);background-color:#fff;padding:%?20?%}.avatar[data-v-0040511e]{width:%?80?%;height:%?80?%;border-radius:50%}.common_style[data-v-0040511e]{line-height:%?80?%;margin-left:%?20?%;color:#000}.real_color[data-v-0040511e]{color:#f30!important}.kaidanmx[data-v-0040511e]{margin-top:%?30?%}.display_flex[data-v-0040511e]{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;background:#fff;padding:%?15?% %?30?%}.display_flex_bet[data-v-0040511e]{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;background:#fff;padding:%?15?% %?30?%;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between}.left_content[data-v-0040511e]{width:%?150?%}",""]),t.exports=e},fae4:function(t,e,i){"use strict";i.r(e);var a=i("6320"),n=i.n(a);for(var o in a)"default"!==o&&function(t){i.d(e,t,(function(){return a[t]}))}(o);e["default"]=n.a}}]);