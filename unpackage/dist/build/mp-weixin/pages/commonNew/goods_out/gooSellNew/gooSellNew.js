(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/commonNew/goods_out/gooSellNew/gooSellNew"],{"0107":function(e,t,o){"use strict";var r=o("b8ff"),s=o.n(r);s.a},"26bc":function(e,t,o){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,s,n=u(o("c74b")),a=u(o("df06"));u(o("da3f")),u(o("b410")),u(o("428b"));function u(e){return e&&e.__esModule?e:{default:e}}var c={data:function(){return{user:e.getStorageSync("user"),identity:e.getStorageSync("identity"),othercurrent:"",Images:[],stock:"",shop_name:"",products:null,button_disabled:!1,beizhu_text:"",real_money:0,all_money:0,allCostPrice:0,really_total_money:0,custom:null,account:"",outType:"",discount:"",pickerTypes:[{desc:"自提",type:1},{desc:"快递",type:2},{desc:"物流",type:3},{desc:"送货上门",type:4}],expressNum:"",total_num:0,nowDay:a.default.getDay(0,!0,!0),otherMoney:0,discountMoney:0,haveGetMoney:0,sellLaterOrderId:""}},onLoad:function(t){s=this,r=e.getStorageSync("uid"),s.products=e.getStorageSync("products"),s.sellLaterOrderId=t.id||"",s.user.rights&&s.user.rights.othercurrent&&(s.othercurrent=s.user.rights.othercurrent);for(var o=0;o<s.products.length;o++)s.all_money=Number((s.products[o].total_money+s.all_money).toFixed(2)),s.really_total_money=Number((s.products[o].really_total_money+s.really_total_money).toFixed(2)),s.total_num+=Number(s.products[o].num),s.allCostPrice=s.allCostPrice+Number(s.products[o].num)*Number(s.products[o].costPrice);s.real_money=Number(s.all_money.toFixed(2)),s.haveGetMoney=Number(s.all_money.toFixed(2))},onShow:function(){s.custom=e.getStorageSync("custom"),s.account=e.getStorageSync("account"),s.stock=e.getStorageSync("warehouse")?e.getStorageSync("warehouse")[0].stock:"",e.getStorageSync("haveGetMoney")&&(s.haveGetMoney=Number(e.getStorageSync("haveGetMoney").toFixed(2)),e.removeStorageSync("haveGetMoney")),e.getStorageSync("otherMoney")&&(s.otherMoney=Number(e.getStorageSync("otherMoney").toFixed(2)),s.haveGetMoney=s.haveGetMoney+s.otherMoney,e.removeStorageSync("otherMoney"))},onUnload:function(){e.removeStorageSync("haveGetMoney"),e.removeStorageSync("otherMoney"),e.removeStorageSync("products")},methods:{inputOtherMoney:function(e){s.haveGetMoney=Number(s.all_money.toFixed(2))+Number(e.detail.value)-Number(s.discountMoney)},inputDiscountMoney:function(e){s.haveGetMoney=Number(s.all_money.toFixed(2))+Number(s.otherMoney)-Number(e.detail.value)},bindDateChange:function(e){s.nowDay=e.detail.value+" 00:00:00"},scan_code:function(){e.scanCode({onlyFromCamera:!0,success:function(e){console.log("条码类型："+e.scanType),console.log("条码内容："+e.result),s.expressNum=e.result}})},removeImg:function(e){s.Images.splice(e,1),s.Images=s.Images},upload_image:function(){s.user.is_vip?e.chooseImage({count:3,sizeType:["compressed"],sourceType:["album","camera"],success:function(e){console.log(e);var t,o=Date.parse(new Date),r=e.tempFilePaths,a=!0,u=!1,c=void 0;try{for(var l,i=r[Symbol.iterator]();!(a=(l=i.next()).done);a=!0){var d=l.value;t=n.default.File(o+".jpg",d)}}catch(m){u=!0,c=m}finally{try{a||null==i.return||i.return()}finally{if(u)throw c}}t.save().then((function(e){var t=!0,o=!1,r=void 0;try{for(var n,a=e[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var u=n.value;s.Images.push(u.url)}}catch(m){o=!0,r=m}finally{try{t||null==a.return||a.return()}finally{if(o)throw r}}}))}}):e.showToast({title:"您还不是会员，无法使用",icon:"none"})},select_outType:function(e){s.outType=s.pickerTypes[e.detail.value],2==s.outType.type&&3==s.outType.type||(s.expressNum="")},formSubmit:function(t){e.getStorageSync("identity");this.button_disabled=!0;t.detail.formId;var o=1;if(e.showLoading({title:"上传中..."}),""==e.getStorageSync("custom")||void 0==e.getStorageSync("custom"))return e.showToast({icon:"none",title:"请选择客户"}),void(this.button_disabled=!1);var u=new Array,c=[],l=n.default.Pointer("customs"),i=l.set(e.getStorageSync("custom").objectId),d=n.default.Pointer("stocks"),m="";s.stock&&s.stock.objectId&&(m=d.set(s.stock.objectId));for(var y=Number(s.real_money)-Number(s.discountMoney)+Number(s.otherMoney),g=y-Number(s.haveGetMoney),f=y-s.allCostPrice,h=0;h<this.products.length;h++){var p=Number(this.products[h].reserve)-this.products[h].num,b=n.default.Query("Bills"),S={},v=n.default.Pointer("_User"),_=v.set(r),N=n.default.Pointer("_User"),M=N.set(e.getStorageSync("masterId")),I=n.default.Pointer("Goods"),w=I.set(this.products[h].objectId);b.set("custom",i),b.set("goodsName",this.products[h].goodsName),b.set("retailPrice",this.products[h].modify_retailPrice),b.set("num",Number(this.products[h].num)),b.set("total_money",this.products[h].total_money),b.set("really_total_money",this.products[h].really_total_money),b.set("allCostPrice",Number(s.products[h].num)*Number(s.products[h].costPrice)),b.set("goodsId",w),b.set("userId",_),b.set("type",-1),b.set("extra_type",o),b.set("opreater",M),b.set("createdTime",{__type:"Date",iso:s.nowDay});var P={};s.stock&&s.stock.objectId?(b.set("status",!0),b.set("stock",m),S.stock=s.stock.stock_name):b.set("status",!1),S.goodsName=this.products[h].goodsName,S.modify_retailPrice=this.products[h].modify_retailPrice.toString(),S.retailPrice=this.products[h].retailPrice,S.total_money=this.products[h].total_money,P.costPrice=this.products[h].costPrice,P.retailPrice=this.products[h].retailPrice,P.objectId=this.products[h].objectId,P.reserve=p,this.products[h].selectd_model&&(P.selected_model=this.products[h].selected_model,P.models=this.products[h].models),S.goodsId=P,S.type=-1,S.num=this.products[h].num,S.warning_num=this.products[h].warning_num,u.push(b),c.push(S)}n.default.Query("Bills").saveAll(u).then((function(u){for(var l=[],d=0;d<u.length;d++)l.push(u[d].success.objectId);var h=n.default.Pointer("_User"),p=h.set(r),b=e.getStorageSync("masterId"),S=n.default.Pointer("_User"),v=S.set(b),_=n.default.Query("order_opreations");if(_.set("detail",c),_.set("bills",l),_.set("beizhu",t.detail.value.input_beizhu),_.set("type",-1),_.set("extra_type",o),_.set("opreater",v),_.set("master",p),_.set("real_num",s.total_num),_.set("goodsName",s.products[0].goodsName),_.set("all_money",s.all_money),_.set("allCostPrice",s.allCostPrice),_.set("profit",f),_.set("otherMoney",Number(s.otherMoney)),_.set("discountMoney",Number(s.discountMoney)),_.set("haveGetMoney",Number(s.haveGetMoney)),_.set("real_money",y),_.set("debt",g),s.account){var N=n.default.Pointer("accounts"),M=N.set(s.account.objectId);_.set("account",M);var I=n.default.Query("accounts");I.get(s.account.objectId).then((function(e){e.set("money",e.money+Number(s.haveGetMoney)),e.save().then((function(e){}))}))}if(_.set("recordType","new"),_.set("createdTime",{__type:"Date",iso:s.nowDay}),_.set("custom",i),g>0){var w=n.default.Query("customs");w.get(s.custom.objectId).then((function(e){var t=null==e.debt?0:e.debt;t+=g,w.get(s.custom.objectId).then((function(e){e.set("debt",t),e.save()}))}))}s.outType&&(_.set("typeDesc",s.outType.desc),_.set("expressNum",s.expressNum)),_.set("Images",s.Images),s.stock?(_.set("status",!0),_.set("stock",m)):_.set("status",!1),_.save().then((function(t){var o=t.objectId;s.stock&&s.stock.objectId?a.default.outRedGoodNumNew(s.products).then((function(t){e.hideLoading(),e.removeStorageSync("customs"),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.setStorageSync("is_option",!0),e.showToast({title:"销售出库成功"}),setTimeout((function(){s.sellLaterOrderId?(_.set("id",s.sellLaterOrderId),_.set("orderSellId",o),_.set("status",!0),_.save().then((function(t){e.navigateBack({delta:2}),s.button_disabled=!1,a.default.log(e.getStorageSync("user").nickName+"销售了'"+s.products[0].goodsName+"'等"+s.products.length+"商品，已经出库",-11,o),console.log(t)}))):(e.navigateBack({delta:2}),s.button_disabled=!1,a.default.log(e.getStorageSync("user").nickName+"销售了'"+s.products[0].goodsName+"'等"+s.products.length+"商品，已经出库",-11,o))}),500)})):e.showToast({title:"产品销售成功",icon:"success",duration:500,success:function(){setTimeout((function(){e.hideLoading(),e.removeStorageSync("customs"),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.setStorageSync("is_option",!0),s.sellLaterOrderId?(_.set("id",s.sellLaterOrderId),_.set("orderSellId",o),_.set("status",!0),_.save().then((function(t){s.button_disabled=!1,a.default.log(e.getStorageSync("user").nickName+"销售了'"+s.products[0].goodsName+"'等"+s.products.length+"商品，暂未出库",-11,o),e.redirectTo({url:"/pages/report/EnteringHistory/SellDetail/SellDetail?id="+o})}))):(s.button_disabled=!1,a.default.log(e.getStorageSync("user").nickName+"销售了'"+s.products[0].goodsName+"'等"+s.products.length+"商品，暂未出库",-11,o),e.redirectTo({url:"/pages/report/EnteringHistory/SellDetail/SellDetail?id="+o}))}),500)}})}))}),(function(e){console.log("异常处理")}))}}};t.default=c}).call(this,o("543d")["default"])},b8ff:function(e,t,o){},d709:function(e,t,o){"use strict";var r,s=function(){var e=this,t=e.$createElement,o=(e._self._c,Number(e.real_money)),r=Number(e.haveGetMoney),s=Number(e.discountMoney),n=Number(e.otherMoney),a=e.nowDay.split(" "),u=Number(e.real_money),c=Number(e.discountMoney),l=Number(e.otherMoney);e.$mp.data=Object.assign({},{$root:{m0:o,m1:r,m2:s,m3:n,g0:a,m4:u,m5:c,m6:l}})},n=[];o.d(t,"b",(function(){return s})),o.d(t,"c",(function(){return n})),o.d(t,"a",(function(){return r}))},e0da:function(e,t,o){"use strict";o.r(t);var r=o("d709"),s=o("ee6c");for(var n in s)"default"!==n&&function(e){o.d(t,e,(function(){return s[e]}))}(n);o("0107");var a,u=o("f0c5"),c=Object(u["a"])(s["default"],r["b"],r["c"],!1,null,null,null,!1,r["a"],a);t["default"]=c.exports},ee6c:function(e,t,o){"use strict";o.r(t);var r=o("26bc"),s=o.n(r);for(var n in r)"default"!==n&&function(e){o.d(t,e,(function(){return r[e]}))}(n);t["default"]=s.a},f448:function(e,t,o){"use strict";(function(e){o("a961"),o("921b");r(o("66fd"));var t=r(o("e0da"));function r(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,o("543d")["createPage"])}},[["f448","common/runtime","common/vendor"]]]);