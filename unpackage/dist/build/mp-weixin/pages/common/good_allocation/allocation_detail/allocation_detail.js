(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/common/good_allocation/allocation_detail/allocation_detail"],{"0fe6":function(e,t,o){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,s,u=a(o("9546")),d=a(o("7fd5")),n=(a(o("9f50")),a(o("856d")));a(o("a2fc"));function a(e){return e&&e.__esModule?e:{default:e}}var c=[],l={data:function(){return{products:[],stock:"",out_stock:"",button_disabled:!1,beizhu_text:"",out_products:[],all_money:0,real_money:0,total_num:0,nowDay:d.default.getDay(0,!0,!0)}},onLoad:function(){s=this,r=e.getStorageSync("uid"),this.products=e.getStorageSync("products");for(var t=0;t<this.products.length;t++)this.all_money=Number((this.products[t].total_money+this.all_money).toFixed(2)),this.total_num+=Number(this.products[t].num);this.real_money=Number(this.all_money.toFixed(2))},onShow:function(){s.out_stock=e.getStorageSync("out_warehouse")?e.getStorageSync("out_warehouse")[0].stock:""},methods:{formSubmit:function(t){if(this.button_disabled=!0,""==s.out_stock||null==s.out_stock)return e.showToast({title:"请选择调入仓库",icon:"none"}),void(this.button_disabled=!1);s.unique(s.products),s.addTbRecord(t)},unique:function(t){for(var o=[t[0]],r=1;r<t.length;r++){for(var u=!1,d=0;d<o.length;d++)if(t[r].header.objectId===o[d].header.objectId){if(t[r].selected_model){var n=!0,a=!1,l=void 0;try{for(var i,m=t[r].selected_model[Symbol.iterator]();!(n=(i=m.next()).done);n=!0){var f=i.value,v=!0,g=!1,p=void 0;try{for(var y,_=o[d].selected_model[Symbol.iterator]();!(v=(y=_.next()).done);v=!0){var b=y.value;b.id==f.id&&(b.num+=Number(f.num))}}catch(h){g=!0,p=h}finally{try{v||null==_.return||_.return()}finally{if(g)throw p}}}}catch(h){a=!0,l=h}finally{try{n||null==m.return||m.return()}finally{if(a)throw l}}}o[d].num+=t[r].num,u=!0}u||o.push(t[r])}console.log(o),s.products=e.getStorageSync("products"),c=o},addTbRecord:function(t){var o,n=this;e.showLoading({title:"请勿退出..."});for(var a=u.default.Pointer("stocks"),l=a.set(s.out_stock.objectId),i=new Array,m=[],f=function(t){var d=u.default.Pointer("stocks");o=d.set(n.products[t].stocks.objectId);var a=u.default.Query("Bills"),c={},f=u.default.Pointer("_User"),v=f.set(r),g=u.default.Pointer("_User"),p=g.set(e.getStorageSync("masterId")),y=u.default.Pointer("Goods"),_=y.set(n.products[t].objectId);a.set("goodsName",n.products[t].goodsName),a.set("retailPrice",n.products[t].modify_retailPrice),a.set("num",Number(n.products[t].num)),a.set("total_money",Number(n.products[t].total_money)),a.set("goodsId",_),a.set("userId",v),a.set("type",-2),a.set("opreater",p),a.set("stock",o),a.set("out_stock",l);var b={};c.goodsName=n.products[t].goodsName,c.stock=n.products[t].stocks.stock_name,c.out_stock=s.out_stock.stock_name,c.reserve=n.products[t].reserve,b.objectId=n.products[t].objectId,n.products[t].selectd_model&&(b.selected_model=n.products[t].selected_model,b.models=n.products[t].models),c.goodsId=b,c.num=Number(n.products[t].num),c.type=-2,i.push(a),m.push(c);var h=u.default.Query("Goods");h.get(s.products[t].objectId).then(function(e){var o=Number(n.products[t].reserve)-Number(n.products[t].num);if(n.products[t].selected_model){var r=!0,s=!1,u=void 0;try{for(var d,a=n.products[t].selected_model[Symbol.iterator]();!(r=(d=a.next()).done);r=!0){var c=d.value,l=!0,i=!1,m=void 0;try{for(var f,v=n.products[t].models[Symbol.iterator]();!(l=(f=v.next()).done);l=!0){var g=f.value;g.id==c.id&&(g.reserve=Number(g.reserve)-Number(c.num)),delete g.num}}catch(p){i=!0,m=p}finally{try{l||null==v.return||v.return()}finally{if(i)throw m}}}}catch(p){s=!0,u=p}finally{try{r||null==a.return||a.return()}finally{if(s)throw u}}e.set("models",n.products[t].models)}e.set("reserve",o),e.save()})},v=0;v<s.products.length;v++)f(v);u.default.Query("Bills").saveAll(i).then(function(n){for(var a=[],i=0;i<n.length;i++)a.push(n[i].success.objectId);var f=u.default.Pointer("_User"),v=f.set(r),g=e.getStorageSync("masterId"),p=u.default.Pointer("_User"),y=p.set(g),_=u.default.Query("order_opreations");_.set("detail",m),_.set("bills",a),_.set("beizhu",t.detail.value.input_beizhu),_.set("type",-2),_.set("opreater",y),_.set("stock",o),_.set("out_stock",l),_.set("master",v),_.set("goodsName",s.products[0].goodsName),_.save().then(function(t){t.objectId;e.hideLoading(),s.button_disabled=!1,e.setStorageSync("is_option",!0);for(var o=function(t){var o=u.default.Query("Goods");o.equalTo("goodsName","==",c[t].goodsName),o.equalTo("userId","==",r),o.equalTo("stocks","==",s.out_stock.objectId),o.find().then(function(r){var u=r;0==u.length?d.default.upload_good_withNoCan(c[t],s.out_stock,Number(c[t].num),"allocation").then(function(o){t==c.length-1&&(e.hideLoading(),e.removeStorageSync("warehouse"),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),e.showToast({title:"调拨成功"}),setTimeout(function(){e.navigateBack({delta:2})},500))}):o.get(u[0].objectId).then(function(o){if(c[t].selected_model){var r=!0,s=!1,d=void 0;try{for(var n,a=c[t].selected_model[Symbol.iterator]();!(r=(n=a.next()).done);r=!0){var l=n.value,i=!0,m=!1,f=void 0;try{for(var v,g=u[0].models[Symbol.iterator]();!(i=(v=g.next()).done);i=!0){var p=v.value;p.id==l.id&&(p.reserve=Number(p.reserve)+Number(l.num)),delete p.num}}catch(y){m=!0,f=y}finally{try{i||null==g.return||g.return()}finally{if(m)throw f}}}}catch(y){s=!0,d=y}finally{try{r||null==a.return||a.return()}finally{if(s)throw d}}o.set("models",u[0].models)}o.set("reserve",Number(u[0].reserve)+Number(c[t].num)),o.save(),t==c.length-1&&(e.hideLoading(),e.removeStorageSync("warehouse"),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),e.showToast({title:"调拨成功"}),setTimeout(function(){e.navigateBack({delta:2})},500))})})},n=0;n<c.length;n++)o(n)})},function(e){console.log("异常处理")})},add_tb_record:function(t){var o=this;e.showLoading({title:"上传中..."});for(var a,c=u.default.Pointer("stocks"),l=c.set(s.out_stock.objectId),i=new Array,m=[],f=function(f){a=c.set(o.products[f].stocks.objectId);var v=u.default.Query("Goods");v.equalTo("goodsName","==",s.products[f].goodsName),v.equalTo("userId","==",r),v.equalTo("stocks","==",s.out_stock.objectId),v.find().then(function(c){console.log(c);var v,g,p=[];if(0==c.length){if(s.products[f].selectd_model)return e.showToast({icon:"none",title:"此多规格产品未关联到此仓库"}),void(o.button_disabled=!1);d.default.upload_good_withNoCan(s.products[f],s.out_stock,Number(o.products[f].num),"allocation").then(function(c){console.log(c);var y={};y.objectId=c[1].objectId,y.reserve=Number(o.products[f].num),p[0]=y,v=Number(o.products[f].reserve)-Number(o.products[f].num),g=Number(o.products[f].num);var _=u.default.Query("Goods");_.get(s.products[f].objectId).then(function(e){e.set("reserve",v),e.save(),_.get(p[0].objectId).then(function(e){e.set("reserve",g),e.save()})});var b=u.default.Query("Bills"),h={},S=u.default.Pointer("_User"),N=S.set(r),k=u.default.Pointer("_User"),I=k.set(e.getStorageSync("masterId")),w=u.default.Pointer("Goods"),j=w.set(o.products[f].objectId);b.set("goodsName",o.products[f].goodsName),b.set("retailPrice",o.products[f].modify_retailPrice),b.set("num",Number(o.products[f].num)),b.set("total_money",Number(o.products[f].total_money)),b.set("goodsId",j),b.set("userId",N),b.set("type",-2),b.set("opreater",I),b.set("stock",a),b.set("out_stock",l);var P={};h.goodsName=o.products[f].goodsName,h.stock=o.products[f].stocks.stock_name,h.out_stock=s.out_stock.stock_name,h.reserve=o.products[f].reserve,h.out_reserve=p[0].reserve,P.objectId=o.products[f].objectId,P.out_objectId=p[0].objectId,P.reserve=v,P.out_reserve=g,o.products[f].selectd_model&&(P.selected_model=o.products[f].selected_model,P.models=o.products[f].models),h.goodsId=P,h.num=Number(o.products[f].num),h.type=-2,i.push(b),m.push(h),f==o.products.length-1&&u.default.Query("Bills").saveAll(i).then(function(o){for(var c=[],i=0;i<o.length;i++)c.push(o[i].success.objectId);var f=u.default.Pointer("_User"),v=f.set(r),g=e.getStorageSync("masterId"),p=u.default.Pointer("_User"),y=p.set(g),_=u.default.Query("order_opreations");_.set("detail",m),_.set("bills",c),_.set("beizhu",t.detail.value.input_beizhu),_.set("type",-2),_.set("opreater",y),_.set("stock",a),_.set("out_stock",l),_.set("master",v),_.set("goodsName",s.products[0].goodsName),_.save().then(function(t){var o=t.objectId;e.hideLoading(),e.showToast({title:"产品调拨成功",icon:"success",success:function(){s.button_disabled=!1,e.setStorageSync("is_option",!0),setTimeout(function(){e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),d.default.log(e.getStorageSync("user").nickName+"调拨了'"+s.products[0].goodsName+"'等"+s.products.length+"商品",-2,t.objectId),e.getStorageSync("setting").auto_print&&n.default.autoPrint(o),e.navigateBack({delta:2})},500)}})})},function(e){console.log("异常处理")})})}else{if(p=c,v=Number(o.products[f].reserve)-Number(o.products[f].num),g=Number(p[0].reserve)+Number(o.products[f].num),o.products[f].stocks.objectId!=s.out_stock.objectId){var y=u.default.Query("Goods");y.get(p[0].objectId).then(function(e){console.log(e);var t=e;if(o.products[f].selectd_model){var r=!0,u=!1,d=void 0;try{for(var n,a=o.products[f].selected_model[Symbol.iterator]();!(r=(n=a.next()).done);r=!0){var c=n.value,l=!0,i=!1,m=void 0;try{for(var p,_=t.models[Symbol.iterator]();!(l=(p=_.next()).done);l=!0){var b=p.value;b.id==c.id&&(b.reserve=Number(b.reserve)+Number(c.num)),delete b.num}}catch(h){i=!0,m=h}finally{try{l||null==_.return||_.return()}finally{if(i)throw m}}}}catch(h){u=!0,d=h}finally{try{r||null==a.return||a.return()}finally{if(u)throw d}}e.set("models",t.models)}e.set("reserve",g),e.save(),y.get(s.products[f].objectId).then(function(e){if(o.products[f].selectd_model){var t=!0,r=!1,s=void 0;try{for(var u,d=o.products[f].selected_model[Symbol.iterator]();!(t=(u=d.next()).done);t=!0){var n=u.value,a=!0,c=!1,l=void 0;try{for(var i,m=o.products[f].models[Symbol.iterator]();!(a=(i=m.next()).done);a=!0){var g=i.value;g.id==n.id&&(g.reserve=Number(g.reserve)-Number(n.num)),delete g.num}}catch(h){c=!0,l=h}finally{try{a||null==m.return||m.return()}finally{if(c)throw l}}}}catch(h){r=!0,s=h}finally{try{t||null==d.return||d.return()}finally{if(r)throw s}}e.set("models",o.products[f].models)}e.set("reserve",v),e.save()})})}var _=u.default.Query("Bills"),b={},h=u.default.Pointer("_User"),S=h.set(r),N=u.default.Pointer("_User"),k=N.set(e.getStorageSync("masterId")),I=u.default.Pointer("Goods"),w=I.set(o.products[f].objectId);_.set("goodsName",o.products[f].goodsName),_.set("num",Number(o.products[f].num)),_.set("goodsId",w),_.set("userId",S),_.set("type",-2),_.set("opreater",k),_.set("stock",a),_.set("out_stock",l);var j={};b.goodsName=o.products[f].goodsName,b.stock=o.products[f].stocks.stock_name,b.out_stock=s.out_stock.stock_name,b.reserve=o.products[f].reserve,b.out_reserve=p[0].reserve,j.objectId=o.products[f].objectId,j.out_objectId=p[0].objectId,j.reserve=v,j.out_reserve=g,o.products[f].selectd_model&&(j.selected_model=o.products[f].selected_model,j.models=o.products[f].models),b.goodsId=j,b.num=Number(o.products[f].num),b.type=-2,i.push(_),m.push(b),f==o.products.length-1&&u.default.Query("Bills").saveAll(i).then(function(o){for(var c=[],i=0;i<o.length;i++)c.push(o[i].success.objectId);var f=u.default.Pointer("_User"),v=f.set(r),g=e.getStorageSync("masterId"),p=u.default.Pointer("_User"),y=p.set(g),_=u.default.Query("order_opreations");_.set("detail",m),_.set("bills",c),_.set("beizhu",t.detail.value.input_beizhu),_.set("type",-2),_.set("opreater",y),_.set("stock",a),_.set("out_stock",l),_.set("master",v),_.set("goodsName",s.products[0].goodsName),_.save().then(function(t){var o=t.objectId;e.showToast({title:"产品调拨成功",icon:"success",success:function(){e.hideLoading(),e.setStorageSync("is_option",!0),e.removeStorageSync("_warehouse"),e.removeStorageSync("out_warehouse"),e.removeStorageSync("category"),e.removeStorageSync("warehouse"),setTimeout(function(){s.button_disabled=!1,d.default.log(e.getStorageSync("user").nickName+"调拨了'"+s.products[0].goodsName+"'等"+s.products.length+"商品",-2,t.objectId),e.getStorageSync("setting").auto_print&&n.default.autoPrint(o),e.navigateBack({delta:2})},500)}})})},function(e){console.log("异常处理")})}})},v=0;v<this.products.length;v++)f(v)}}};t.default=l}).call(this,o("543d")["default"])},"49e6":function(e,t,o){"use strict";var r=o("9085"),s=o.n(r);s.a},"64a8":function(e,t,o){"use strict";o.r(t);var r=o("8cbd"),s=o("f43f");for(var u in s)"default"!==u&&function(e){o.d(t,e,function(){return s[e]})}(u);o("49e6");var d,n=o("f0c5"),a=Object(n["a"])(s["default"],r["b"],r["c"],!1,null,null,null,!1,r["a"],d);t["default"]=a.exports},"8cbd":function(e,t,o){"use strict";var r,s=function(){var e=this,t=e.$createElement,o=(e._self._c,e.nowDay.split(" "));e.$mp.data=Object.assign({},{$root:{g0:o}})},u=[];o.d(t,"b",function(){return s}),o.d(t,"c",function(){return u}),o.d(t,"a",function(){return r})},9085:function(e,t,o){},f43f:function(e,t,o){"use strict";o.r(t);var r=o("0fe6"),s=o.n(r);for(var u in r)"default"!==u&&function(e){o.d(t,e,function(){return r[e]})}(u);t["default"]=s.a},fb19:function(e,t,o){"use strict";(function(e){o("d510"),o("921b");r(o("66fd"));var t=r(o("64a8"));function r(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,o("543d")["createPage"])}},[["fb19","common/runtime","common/vendor"]]]);