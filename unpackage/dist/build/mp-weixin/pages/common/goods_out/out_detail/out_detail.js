(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/common/goods_out/out_detail/out_detail"],{"0279":function(t,e,o){"use strict";(function(t){o("a961"),o("921b");s(o("66fd"));var e=s(o("7b57"));function s(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("543d")["createPage"])},7874:function(t,e,o){"use strict";o.r(e);var s=o("a573"),r=o.n(s);for(var u in s)"default"!==u&&function(t){o.d(e,t,function(){return s[t]})}(u);e["default"]=r.a},"7b57":function(t,e,o){"use strict";o.r(e);var s=o("d469"),r=o("7874");for(var u in r)"default"!==u&&function(t){o.d(e,t,function(){return r[t]})}(u);o("8a61");var a=o("2877"),n=Object(a["a"])(r["default"],s["a"],s["b"],!1,null,null,null);e["default"]=n.exports},"8a61":function(t,e,o){"use strict";var s=o("ed24"),r=o.n(s);r.a},a573:function(t,e,o){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var s,r,u,a,n=i(o("c74b")),c=i(o("df06")),d=i(o("da3f")),l=i(o("b410"));function i(t){return t&&t.__esModule?t:{default:t}}var m={data:function(){return{stock:"",shop_name:"",products:null,button_disabled:!1,beizhu_text:"",real_money:0,all_money:0,custom:null,outType:"",discount:"",pickerTypes:[{desc:"自提",type:1},{desc:"快递",type:2},{desc:"物流",type:3},{desc:"送货上门",type:4}],expressNum:""}},onLoad:function(){r=this,s=t.getStorageSync("uid"),this.products=t.getStorageSync("products")},onShow:function(){if(this.really_total_money=0,this.all_money=0,this.real_money=0,r.custom=t.getStorageSync("custom"),a=t.getStorageSync("shop"),a){r.shop_name=a.name;var e=n.default.Pointer("shops");u=e.set(a.objectId)}if(r.custom.discount){r.discount=r.custom.discount;for(var o=0;o<this.products.length;o++)this.all_money=Number((this.products[o].total_money+this.all_money).toFixed(2)),this.really_total_money=Number((this.products[o].really_total_money+this.really_total_money).toFixed(2));this.really_total_money=this.really_total_money*r.discount/100,this.real_money=Number(this.all_money.toFixed(2))*r.discount/100,this.all_money=this.all_money*r.discount/100}else{for(var s=0;s<this.products.length;s++)this.all_money=Number((this.products[s].total_money+this.all_money).toFixed(2)),this.really_total_money=Number((this.products[s].really_total_money+this.really_total_money).toFixed(2));this.real_money=Number(this.all_money.toFixed(2))}r.stock=t.getStorageSync("warehouse")?t.getStorageSync("warehouse")[0].stock:""},methods:{getDiscount:function(t){var e=Number(t.detail.value);e>=100?r.discount=100:(r.discount=e,r.real_money=Number(this.all_money.toFixed(2))*e/100)},select_outType:function(t){r.outType=r.pickerTypes[t.detail.value],2==r.outType.type&&3==r.outType.type||(r.expressNum="")},formSubmit:function(e){console.log(e);var o=e.detail.formId,i=Number(e.detail.target.dataset.type);this.button_disabled=!0,t.showLoading({title:"上传中..."});for(var m=n.default.Pointer("stocks"),y=m.set(r.stock?r.stock.objectId:""),p=new Array,_=[],f=0;f<this.products.length;f++){var h=Number(this.products[f].reserve)-this.products[f].num,g=n.default.Query("Bills"),b={},v=n.default.Pointer("_User"),S=v.set(s),N=n.default.Pointer("_User"),k=N.set(t.getStorageSync("masterId")),I=n.default.Pointer("Goods"),w=I.set(this.products[f].objectId);if(t.getStorageSync("custom")){var P=n.default.Pointer("customs"),j=P.set(t.getStorageSync("custom").objectId);g.set("custom",j)}g.set("goodsName",this.products[f].goodsName),g.set("retailPrice",this.products[f].modify_retailPrice.toString()),g.set("num",Number(this.products[f].num)),g.set("total_money",this.products[f].total_money),g.set("really_total_money",this.products[f].really_total_money),g.set("goodsId",w),g.set("userId",S),g.set("type",-1),g.set("extra_type",i),g.set("opreater",k),g.set("stock",y);var x={};b.goodsName=this.products[f].goodsName,b.modify_retailPrice=this.products[f].modify_retailPrice.toString(),b.retailPrice=this.products[f].retailPrice,b.total_money=this.products[f].total_money,x.costPrice=this.products[f].costPrice,x.retailPrice=this.products[f].retailPrice,x.objectId=this.products[f].objectId,x.reserve=h,b.goodsId=x,b.num=this.products[f].num,b.type=-1,a&&(g.set("shop",u),c.default.record_shopOut(a.objectId,a.have_out+this.products[f].num)),p.push(g),_.push(b),c.default.record_staffOut(this.products[f].num)}n.default.Query("Bills").saveAll(p).then(function(m){for(var p=[],f=0;f<m.length;f++)p.push(m[f].success.objectId);var h=n.default.Pointer("_User"),g=h.set(s),b=t.getStorageSync("masterId"),v=n.default.Pointer("_User"),S=v.set(b),N=n.default.Query("order_opreations");if(N.set("detail",_),N.set("bills",p),N.set("beizhu",e.detail.value.input_beizhu),N.set("type",-1),N.set("extra_type",i),N.set("opreater",S),N.set("stock",y),N.set("master",g),r.discount&&N.set("discount",r.discount),N.set("goodsName",r.products[0].goodsName),N.set("real_money",Number(r.real_money)),N.set("debt",r.all_money-Number(r.real_money)),a&&N.set("shop",u),r.custom){var k=n.default.Pointer("customs"),I=k.set(r.custom.objectId);if(N.set("custom",I),r.all_money-Number(r.real_money)>0){var w=n.default.Query("customs");w.get(r.custom.objectId).then(function(t){var e=null==t.debt?0:t.debt;e+=r.all_money-Number(r.real_money),console.log(e);var o=n.default.Query("customs");o.get(r.custom.objectId).then(function(t){t.set("debt",e),t.save()})})}}r.outType&&(N.set("typeDesc",r.outType.desc),N.set("expressNum",r.expressNum)),N.set("all_money",r.all_money),N.save().then(function(s){var u=s.objectId;t.hideLoading(),t.removeStorageSync("customs"),t.showToast({title:"产品出库成功",icon:"success",success:function(){for(var a=function(t){var e=0,o=n.default.Query("Goods");o.get(r.products[t].objectId).then(function(o){if(r.products[t].warning_num>=r.products[t].reserve&&c.default.log(r.products[t].goodsName+"出库了"+r.products[t].num+"件，已经低于预警数量"+r.products[t].warning_num,-2,r.products[t].objectId),r.products[t].selectd_model){var s=!0,u=!1,a=void 0;try{for(var n,d=JSON.parse(r.products[t].selectd_model)[Symbol.iterator]();!(s=(n=d.next()).done);s=!0){var l=n.value,i=!0,m=!1,y=void 0;try{for(var p,_=r.products[t].models[Symbol.iterator]();!(i=(p=_.next()).done);i=!0){var f=p.value;e+=Number(f.reserve),f.id==JSON.parse(l).id&&(f.reserve=Number(f.reserve)-Number(r.products[t].num))}}catch(h){m=!0,y=h}finally{try{i||null==_.return||_.return()}finally{if(m)throw y}}}}catch(h){u=!0,a=h}finally{try{s||null==d.return||d.return()}finally{if(u)throw a}}e-=Number(r.products[t].num),o.set("models",r.products[t].models)}else e=Number(r.products[t].reserve)-Number(r.products[t].num);o.set("reserve",e),o.set("stocktype",e>r.products[t].warning_num?1:0),o.save()}).catch(function(t){console.log(t)})},i=0;i<r.products.length;i++)a(i);r.button_disabled=!1,t.setStorageSync("is_option",!0),setTimeout(function(){t.removeStorageSync("_warehouse"),t.removeStorageSync("out_warehouse"),t.removeStorageSync("category"),t.removeStorageSync("warehouse"),c.default.log(t.getStorageSync("user").nickName+"出库了'"+r.products[0].goodsName+"'等"+r.products.length+"商品",-1,s.objectId);var a={data1:s.objectId,data2:t.getStorageSync("user").nickName+"出库了'"+r.products[0].goodsName+"'等"+r.products.length+"商品",data3:r.stock?r.stock.stock_name:"未填写",data4:s.createdAt,remark:e.detail.value.input_beizhu?e.detail.value.input_beizhu:"未填写",url:"https://www.jimuzhou.com/h5/pages/report/EnteringHistory/detail/detail?id="+s.objectId};d.default.send_temp(a);var n={keyword1:{value:r.products[0].goodsName+"'等",color:"#173177"},keyword2:{value:e.detail.value.input_beizhu?e.detail.value.input_beizhu:"未填写"},keyword3:{value:s.createdAt},keyword4:{value:t.getStorageSync("user").nickName}};n.form_Id=o,n.id=s.objectId,d.default.send_out_mini(n),t.getStorageSync("setting").auto_print&&l.default.autoPrint(u),t.navigateBack({delta:2})},500)}})})},function(t){console.log("异常处理")})}}};e.default=m}).call(this,o("543d")["default"])},d469:function(t,e,o){"use strict";var s=function(){var t=this,e=t.$createElement;t._self._c},r=[];o.d(e,"a",function(){return s}),o.d(e,"b",function(){return r})},ed24:function(t,e,o){}},[["0279","common/runtime","common/vendor"]]]);