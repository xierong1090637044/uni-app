(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/manage/good_add/good_add"],{"1df3":function(e,o,t){"use strict";t.r(o);var n=t("b932"),r=t("974b");for(var a in r)"default"!==a&&function(e){t.d(o,e,function(){return r[e]})}(a);t("f987");var s,c=t("f0c5"),u=Object(c["a"])(r["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],s);o["default"]=u.exports},"714b":function(e,o,t){"use strict";(function(e){t("9787"),t("921b");n(t("66fd"));var o=n(t("1df3"));function n(e){return e&&e.__esModule?e:{default:e}}e(o.default)}).call(this,t("543d")["createPage"])},"7e22":function(e,o,t){"use strict";(function(e){Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;var n=a(t("93d5")),r=a(t("2839"));function a(e){return e&&e.__esModule?e:{default:e}}var s,c,u=function(){return t.e("components/kilvn-fa-icon/fa-icon").then(t.bind(null,"d7ee"))},i=function(){return t.e("components/uni-collapse/uni-collapse").then(t.bind(null,"f698"))},d=function(){return t.e("components/uni-collapse-item/uni-collapse-item").then(t.bind(null,"4b7b"))},l="",g="",m={components:{uniCollapse:i,uniCollapseItem:d,faIcon:u},data:function(){return{text_desc:"保存",goodsName:"",costPrice:"",retailPrice:"",packageContent:"",packingUnit:"",warning_num:"",max_num:"",producer:"",regNumber:"",position:"",product_info:"",productCode:"",category:"",reserve:0,goodsIcon:"",stock_name:"",stocks:"",producttime:"",nousetime:"",product_state:!1,isMoreModelAdd:e.getStorageSync("addMoreModel")}},onLoad:function(o){if(s=this,c=e.getStorageSync("uid"),e.removeStorageSync("category"),e.removeStorageSync("is_add"),e.getStorageSync("now_product")){e.setNavigationBarTitle({title:"编辑产品"});var t=e.getStorageSync("now_product");if(s.text_desc="修改",s.goodsName=t.goodsName,s.costPrice=t.costPrice,s.retailPrice=t.retailPrice,s.packageContent=t.packageContent,s.packingUnit=t.packingUnit,s.warning_num=t.warning_num,s.producer=t.producer,s.regNumber=t.regNumber,s.position=t.position,s.product_info=t.product_info,s.productCode=t.productCode,s.category=t.second_class?t.second_class:"",s.reserve=t.reserve,s.goodsIcon=t.goodsIcon?t.goodsIcon:"",s.product_state=t.product_state,s.nousetime=t.nousetime?r.default.js_date_time(t.nousetime):"",s.max_num=t.max_num,t.goodsClass&&t.goodsClass.objectId){var a=n.default.Pointer("class_user");l=a.set(t.goodsClass.objectId),t.goodsClass.type=2,e.setStorageSync("category",t.goodsClass)}if(t.second_class&&t.second_class.objectId){var u=n.default.Pointer("second_class");g=u.set(t.second_class.objectId),t.second_class.type=2,e.setStorageSync("category",t.second_class)}t.stocks&&t.stocks.length>0&&e.setStorageSync("warehouse",t.stocks)}else{var i=n.default.Query("stocks");i.order("-num"),i.equalTo("parent","==",c),i.equalTo("disabled","!=",!0),i.find().then(function(o){var t=!0,n=!1,r=void 0;try{for(var a,s=o[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var c=a.value;c.reserve=0}}catch(u){n=!0,r=u}finally{try{t||null==s.return||s.return()}finally{if(n)throw r}}e.setStorageSync("warehouse",o)})}},onShow:function(){if(e.getStorageSync("warehouse")){s.reserve=0;var o=e.getStorageSync("warehouse"),t=!0,r=!1,a=void 0;try{for(var c,u=o[Symbol.iterator]();!(t=(c=u.next()).done);t=!0){var i=c.value;s.reserve+=Number(i.reserve)}}catch(p){r=!0,a=p}finally{try{t||null==u.return||u.return()}finally{if(r)throw a}}}if(e.getStorageSync("category"))if(s.category=e.getStorageSync("category"),2==s.category.type){if(s.category.parent.objectId){var d=n.default.Pointer("class_user");l=d.set(s.category.parent.objectId)}if(s.category.objectId){var m=n.default.Pointer("second_class");g=m.set(s.category.objectId)}console.log(s.category.parent.objectId,s.category.objectId)}else{var f=n.default.Pointer("class_user");l=f.set(s.category.objectId)}},onUnload:function(){l="",g="",r.default.handleData()},methods:{scan_by_id:function(e){console.log(e),wx.showLoading({title:"加载中..."}),wx.request({url:"https://route.showapi.com/66-22",data:{showapi_appid:"84916",showapi_sign:"ad4b63369c834759b411a9d7fcb07ed7",code:e},header:{"content-type":"application/json"},success:function(o){wx.hideLoading();var t=o.data.showapi_res_body;console.log(t),s.goodsName=t.goodsName,s.producer=t.manuName,s.goodsIcon=t.img,s.product_info=t.note,s.productCode=e}})},scan_code:function(){e.scanCode({onlyFromCamera:!0,success:function(e){console.log("条码类型："+e.scanType),console.log("条码内容："+e.result),s.productCode=e.result}})},bindDateChange:function(e){s.nousetime=e.target.value},formSubmit:function(o){console.log(o.detail.value);var t=o.detail.value;""==t.goodsName?e.showToast({title:"请输入产品名称",icon:"none"}):null==e.getStorageSync("category")||""==e.getStorageSync("category")?e.showToast({title:"请选择产品类别",icon:"none"}):s.upload_good(t)},upload_image:function(){e.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:function(e){console.log(e);var o,t=Date.parse(new Date),r=e.tempFilePaths,a=!0,c=!1,u=void 0;try{for(var i,d=r[Symbol.iterator]();!(a=(i=d.next()).done);a=!0){var l=i.value;o=n.default.File(t+".jpg",l)}}catch(g){c=!0,u=g}finally{try{a||null==d.return||d.return()}finally{if(c)throw u}}o.save().then(function(e){s.goodsIcon=e[0].url})}})},upload_good:function(o){if(e.showLoading({title:"上传中..."}),""!=o.max_num&&""!=o.warning_num&&Number(o.max_num)<=Number(o.warning_num))e.showToast({title:"最大库存数须大于预警数",icon:"none"});else if(e.getStorageSync("now_product"))s.edit_good(o);else{var t=n.default.Query("NGoods");t.equalTo("userId","==",c),t.equalTo("status","!=",-1),t.equalTo("goodsName","==",o.goodsName),t.equalTo("position","==",o.position),t.equalTo("stocks","==",s.stocks.objectId),t.find().then(function(t){t.length>=1?e.showToast({title:"你的库存中已存在此产品",icon:"none"}):s.add_good(o,"add")})}},edit_good:function(o){var t=e.getStorageSync("now_product"),a=n.default.Pointer("_User"),u=a.set(c),i=n.default.Query("NGoods");if(i.set("goodsIcon",s.goodsIcon?s.goodsIcon:""),i.set("goodsName",o.goodsName),i.set("costPrice",o.costPrice?Number(o.costPrice):0),i.set("retailPrice",o.retailPrice?Number(o.retailPrice):0),s.nousetime){var d=s.nousetime.replace(new RegExp("-","g"),"/");d=new Date(d).getTime(),i.set("nousetime",d)}i.set("regNumber",o.regNumber),i.set("reserve",Number(o.reserve)),i.set("productCode",o.productCode),i.set("product_info",o.product_info),i.set("producer",o.producer),i.set("packingUnit",o.packingUnit),i.set("packageContent",o.packageContent),i.set("position",o.position),i.set("warning_num",Number(o.warning_num)),i.set("max_num",Number(o.max_num)),""==o.warning_num&&""==o.max_num?i.set("stocktype",1):(""!=o.warning_num&&(i.set("warning_num",Number(o.warning_num)),i.set("stocktype",Number(o.warning_num)>=Number(s.reserve)?0:1)),""!=o.max_num&&(i.set("max_num",Number(o.max_num)),i.set("stocktype",Number(o.max_num)<=Number(s.reserve)?2:1))),i.set("product_state",o.product_state),i.set("order",0),e.getStorageSync("category")&&(1==s.category.type?i.set("goodsClass",l):(i.set("goodsClass",l),i.set("second_class",g))),i.set("userId",u),i.set("id",t.objectId),i.save().then(function(a){if(e.getStorageSync("warehouse")&&e.getStorageSync("warehouse").length>0)for(var s=e.getStorageSync("warehouse"),c=function(){console.log(s[u]);var e=s[u],t=n.default.Query("NGoods");t.get(e.good_id).then(function(t){console.log(t,e),t.set("reserve",Number(e.reserve)),t.set("retailPrice",Number(o.retailPrice)),t.set("costPrice",Number(o.costPrice)),t.set("goodsName",o.goodsName),t.save()}).catch(function(e){console.log(e)})},u=0;u<s.length;u++)c();e.hideLoading(),r.default.log(e.getStorageSync("user").nickName+"修改了产品'"+t.goodsName+"'",5,t.objectId),e.setStorageSync("is_add",!0),e.navigateBack({delta:2}),setTimeout(function(){e.showToast({title:"修改成功"})},1e3)})},add_good:function(o,t){e.getStorageSync("now_product");var a=n.default.Pointer("_User"),u=a.set(c),i=n.default.Query("NGoods");if(i.set("goodsIcon",s.goodsIcon?s.goodsIcon:""),i.set("goodsName",o.goodsName),i.set("costPrice",o.costPrice?Number(o.costPrice):0),i.set("retailPrice",o.retailPrice?Number(o.retailPrice):0),s.nousetime){var d=s.nousetime.replace(new RegExp("-","g"),"/");d=new Date(d).getTime(),i.set("nousetime",d)}i.set("regNumber",o.regNumber),i.set("reserve",Number(o.reserve)),i.set("productCode",o.productCode),i.set("product_info",o.product_info),i.set("producer",o.producer),i.set("packingUnit",o.packingUnit),i.set("packageContent",o.packageContent),i.set("position",o.position),i.set("warning_num",Number(o.warning_num)),i.set("max_num",Number(o.max_num)),""==o.warning_num&&""==o.max_num?i.set("stocktype",1):(""!=o.warning_num&&(i.set("warning_num",Number(o.warning_num)),i.set("stocktype",Number(o.warning_num)>=Number(s.reserve)?0:1)),""!=o.max_num&&(i.set("max_num",Number(o.max_num)),i.set("stocktype",Number(o.max_num)<=Number(s.reserve)?2:1))),i.set("product_state",o.product_state),i.set("order",0),e.getStorageSync("category")&&(1==s.category.type?i.set("goodsClass",l):(i.set("goodsClass",l),i.set("second_class",g))),i.set("userId",u),i.save().then(function(t){var a=t,s=e.getStorageSync("warehouse")||[];if(s.length>0){for(var c=new Array,i=0;i<s.length;i++){var d=n.default.Pointer("stocks"),l=d.set(s[i].objectId),g=n.default.Pointer("NGoods"),m=g.set(a.objectId),f=n.default.Query("NGoods");f.set("order",1),f.set("goodsName",o.goodsName),f.set("costPrice",Number(o.costPrice)),f.set("retailPrice",Number(o.retailPrice)),f.set("header",m),f.set("userId",u),f.set("stocks",l),f.set("reserve",Number(s[i].reserve)),c.push(f)}n.default.Query("NGoods").saveAll(c).then(function(t){console.log(t),e.hideLoading(),r.default.log(e.getStorageSync("user").nickName+"增加了产品'"+o.goodsName+"'",5,a.objectId),e.showToast({title:"上传成功"}),e.setStorageSync("is_add",!0)}).catch(function(e){console.log(e)})}else e.hideLoading(),r.default.log(e.getStorageSync("user").nickName+"增加了产品'"+o.goodsName+"'",5,a.objectId),e.showToast({title:"上传成功"}),e.setStorageSync("is_add",!0)}).catch(function(e){console.log(e)})},handledata:function(){s.goodsName="",s.costPrice="",s.retailPrice="",s.packageContent="",s.packingUnit="",s.warning_num="",s.producer="",s.regNumber="",s.position="",s.product_info="",s.productCode="",s.category="",s.reserve=0,s.goodsIcon="",s.stocks="",s.stock_name="",s.producttime="",s.nousetime=""}}};o.default=m}).call(this,t("543d")["default"])},"974b":function(e,o,t){"use strict";t.r(o);var n=t("7e22"),r=t.n(n);for(var a in n)"default"!==a&&function(e){t.d(o,e,function(){return n[e]})}(a);o["default"]=r.a},b5ff:function(e,o,t){},b932:function(e,o,t){"use strict";var n,r=function(){var e=this,o=e.$createElement;e._self._c},a=[];t.d(o,"b",function(){return r}),t.d(o,"c",function(){return a}),t.d(o,"a",function(){return n})},f987:function(e,o,t){"use strict";var n=t("b5ff"),r=t.n(n);r.a}},[["714b","common/runtime","common/vendor"]]]);