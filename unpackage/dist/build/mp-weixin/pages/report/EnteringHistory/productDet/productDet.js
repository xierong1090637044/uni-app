(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/report/EnteringHistory/productDet/productDet"],{"14b4":function(t,e,o){"use strict";(function(t){o("d510"),o("921b");r(o("66fd"));var e=r(o("aab3"));function r(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("543d")["createPage"])},4479:function(t,e,o){"use strict";var r=o("c59e"),n=o.n(r);n.a},"4fa1":function(t,e,o){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var r=a(o("9546")),n=(a(o("856d")),a(o("7fd5")));function a(t){return t&&t.__esModule?t:{default:t}}var s,i,l=function(){return Promise.all([o.e("common/vendor"),o.e("components/tki-qrcode/tki-qrcode")]).then(o.bind(null,"13d4"))},u=function(){return o.e("components/Loading/index").then(o.bind(null,"120a"))},c=function(){return o.e("components/uni-nav-bar/uni-nav-bar").then(o.bind(null,"96bd"))},d={components:{tkiQrcode:l,loading:u,uniNavBar:c},data:function(){return{user:t.getStorageSync("user"),identity:t.getStorageSync("identity"),othercurrent:"",bills:[],loading:!0,products:null,detail:null,matters:[],all_money:0,really_total_money:0,real_money:0,enterNum:0}},onLoad:function(t){console.log(t),s=this,i=t.id,s.user.rights&&s.user.rights.othercurrent&&(s.othercurrent=s.user.rights.othercurrent)},onShow:function(){s.getdetail(i)},methods:{show_options:function(){t.showActionSheet({itemList:["领料","生产完成","入库"],success:function(t){var e=t.tapIndex;0==e?s.confrimMatter():1==e?s.confrimComplete():2==e&&s.confrimEnter()},fail:function(t){console.log(t.errMsg)}})},confrimEnter:function(){if(0==s.detail.status)t.showToast({icon:"none",title:"未生产完成！"});else if(0==s.detail.matterStatus)t.showToast({icon:"none",title:"未领料！"});else if(s.enterNum==s.detail.real_num)t.showToast({icon:"none",title:"已经全部入库了！"});else{var e=[],o=!0,n=!1,a=void 0;try{for(var l,u=s.detail.detail[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){var c=l.value;e.push(c.goodsId.objectId)}}catch(m){n=!0,a=m}finally{try{o||null==u.return||u.return()}finally{if(n)throw a}}var d=r.default.Query("Goods");d.containedIn("objectId",e),d.find().then(function(e){var o=!0,r=!1,n=void 0;try{for(var a,l=e[Symbol.iterator]();!(o=(a=l.next()).done);o=!0){var u=a.value,c=!0,d=!1,f=void 0;try{for(var y,g=s.detail.detail[Symbol.iterator]();!(c=(y=g.next()).done);c=!0){var v=y.value;v.goodsId.objectId==u.objectId&&(v.enterNum?u.num=v.num-v.enterNum:u.num=v.num,u.total_money=v.num*u.costPrice,u.really_total_money=v.num*u.costPrice,u.modify_retailPrice=u.costPrice)}}catch(m){d=!0,f=m}finally{try{c||null==g.return||g.return()}finally{if(d)throw f}}}}catch(m){r=!0,n=m}finally{try{o||null==l.return||l.return()}finally{if(r)throw n}}console.log(e),t.setStorageSync("products",e),t.setStorageSync("detailBills",s.detail.detail),t.navigateTo({url:"/pages/report/EnteringHistory/productDet/productEnter/productEnter?id="+i})})}},confrimComplete:function(){t.showModal({title:"提示",content:"是否确认生产完成",success:function(e){if(e.confirm)if(s.detail.status)t.showToast({title:"已经生产完成！"});else{t.showLoading({title:"生产中..."});var o=r.default.Query("order_opreations");o.set("id",i),o.set("status",!0),o.save().then(function(e){var o=r.default.Query("Bills");o.containedIn("objectId",s.detail.bills),o.find().then(function(e){e.set("status",!0),e.saveAll().then(function(e){t.showToast({title:"生产完成"}),s.getdetail(i)})})})}}})},confrimMatter:function(){s.detail.mattersId&&s.detail.mattersId.length>0?t.showModal({title:"是否确认领料",content:"领料后不可修改",success:function(e){if(e.confirm)if(s.detail.matterStatus)t.showToast({title:"已经领过物料！"});else{for(var o=new Array,a=[],l=t.getStorageSync("uid"),u=0,c=0;c<s.matters.length;c++){var d=Number(s.matters[c].reserve)-s.matters[c].num;u+=s.matters[c].num;var m={},f=r.default.Query("Bills"),y=r.default.Pointer("_User"),g=y.set(l),v=r.default.Pointer("Matters"),h=v.set(s.matters[c].objectId),_=t.getStorageSync("masterId"),b=r.default.Pointer("_User"),p=b.set(_);f.set("goodsName",s.matters[c].goodsName),f.set("retailPrice",s.matters[c].modify_retailPrice.toString()),f.set("num",Number(s.matters[c].num)),f.set("total_money",s.matters[c].total_money),f.set("really_total_money",s.matters[c].really_total_money),f.set("mattersId",h),f.set("userId",g),f.set("opreater",p),f.set("type",6);var S={};m.goodsName=s.matters[c].goodsName,m.modify_retailPrice=s.matters[c].modify_retailPrice.toString(),m.retailPrice=s.matters[c].retailPrice,m.total_money=s.matters[c].total_money,S.costPrice=s.matters[c].costPrice,S.retailPrice=s.matters[c].retailPrice,S.objectId=s.matters[c].objectId,S.reserve=d,s.matters[c].selectd_model&&(S.selected_model=s.matters[c].selected_model,S.models=s.matters[c].models),m.goodsId=S,m.num=s.matters[c].num,m.type=6,o.push(f),a.push(m)}r.default.Query("Bills").saveAll(o).then(function(e){for(var o=[],c=0;c<e.length;c++)o.push(e[c].success.objectId);var d=r.default.Pointer("_User"),m=d.set(l),f=t.getStorageSync("masterId"),y=r.default.Pointer("_User"),g=y.set(f),v=r.default.Query("order_opreations");v.set("detail",a),v.set("real_num",u),v.set("type",6),v.set("bills",o),v.set("opreater",g),v.set("master",m),v.set("goodsName",s.matters[0].goodsName),v.set("all_money",s.all_money),v.save().then(function(e){var o=e.objectId;t.hideLoading();var a=r.default.Query("order_opreations");a.set("id",i),a.set("matterStatus",!0),a.save().then(function(e){t.showToast({title:"领料成功",icon:"success",duration:1e3,complete:function(){s.outRedGoodNum(s.matters).then(function(e){n.default.log(t.getStorageSync("user").nickName+"确认领了'"+s.matters[0].goodsName+"'等"+s.matters.length+"物料",6,o),t.setStorageSync("is_option",!0),t.removeStorageSync("_warehouse"),t.removeStorageSync("out_warehouse"),t.removeStorageSync("category"),t.removeStorageSync("warehouse"),s.getdetail(i)})}})}).catch(function(t){console.log(t)})})})}else e.cancel&&console.log("用户点击取消")}}):t.showToast({title:"请先添加物料",icon:"none"})},outRedGoodNum:function(t){return new Promise(function(e,o){for(var a=function(o){var a=0,s=r.default.Query("Matters");s.get(t[o].objectId).then(function(r){a=Number(t[o].reserve)-Number(t[o].num),r.set("reserve",a),r.set("stocktype",a>=t[o].warning_num?1:0),r.save(),t[o].warning_num>=a&&n.default.log(t[o].goodsName+"在生产时领了"+t[o].num+"件，已经低于预警数量"+t[o].warning_num,-2,t[o].objectId),o==t.length-1&&e(!0)}).catch(function(t){console.log(t)})},s=0;s<t.length;s++)a(s)})},priview:function(e){t.previewImage({current:e,urls:s.detail.Images})},getdetail:function(t){var e=this,o=r.default.Query("order_opreations");o.include("opreater","custom","producer","stock"),o.get(t).then(function(t){if(console.log(t),t.startDay&&(t.startDay=n.default.js_date_time(t.startDay)),t.endDay&&(t.endDay=n.default.js_date_time(t.endDay)),s.detail=t,s.products=t.detail,s.bills=t.bills,t.mattersId&&t.mattersId.length>0){s.matters=t.mattersId;for(var o=0;o<e.matters.length;o++)e.all_money=Number((e.matters[o].total_money+e.all_money).toFixed(2)),e.really_total_money=Number((e.matters[o].really_total_money+e.really_total_money).toFixed(2)),e.total_num+=Number(e.matters[o].num);e.real_money=Number(e.all_money.toFixed(2))}var r=!0,a=!1,i=void 0;try{for(var l,u=t.detail[Symbol.iterator]();!(r=(l=u.next()).done);r=!0){var c=l.value;c.enterNum&&(s.enterNum+=c.enterNum)}}catch(d){a=!0,i=d}finally{try{r||null==u.return||u.return()}finally{if(a)throw i}}s.loading=!1}).catch(function(t){console.log(t)})},qrR:function(t){this.src=t},bcR:function(t){this.src=t},saveBccode:function(){this.$refs.barcode._saveCode()},saveQrcode:function(){this.$refs.qrcode._saveCode()}}};e.default=d}).call(this,o("543d")["default"])},6904:function(t,e,o){"use strict";var r,n=function(){var t=this,e=t.$createElement;t._self._c},a=[];o.d(e,"b",function(){return n}),o.d(e,"c",function(){return a}),o.d(e,"a",function(){return r})},aab3:function(t,e,o){"use strict";o.r(e);var r=o("6904"),n=o("fae4");for(var a in n)"default"!==a&&function(t){o.d(e,t,function(){return n[t]})}(a);o("4479");var s,i=o("f0c5"),l=Object(i["a"])(n["default"],r["b"],r["c"],!1,null,null,null,!1,r["a"],s);e["default"]=l.exports},c59e:function(t,e,o){},fae4:function(t,e,o){"use strict";o.r(e);var r=o("4fa1"),n=o.n(r);for(var a in r)"default"!==a&&function(t){o.d(e,t,function(){return r[t]})}(a);e["default"]=n.a}},[["14b4","common/runtime","common/vendor"]]]);