(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/report/EnteringHistory/detail/detail"],{"05625":function(e,t,o){"use strict";(function(e){o("9787"),o("921b");n(o("66fd"));var t=n(o("3cf2"));function n(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,o("543d")["createPage"])},3654:function(e,t,o){},"3cf2":function(e,t,o){"use strict";o.r(t);var n=o("946f"),s=o("4e89");for(var i in s)"default"!==i&&function(e){o.d(t,e,function(){return s[e]})}(i);o("b05a");var r,c=o("f0c5"),u=Object(c["a"])(s["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],r);t["default"]=u.exports},"4d40":function(e,t,o){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=i(o("93d5")),s=(i(o("844a")),i(o("2839")));function i(e){return e&&e.__esModule?e:{default:e}}var r,c,u=function(){return o.e("components/Loading/index").then(o.bind(null,"359f"))},a=function(){return o.e("components/uni-nav-bar/uni-nav-bar").then(o.bind(null,"904c"))},l=e.getStorageSync("uid"),d={components:{loading:u,uniNavBar:a},data:function(){return{user:e.getStorageSync("user"),identity:e.getStorageSync("identity"),othercurrent:"",bills:[],loading:!0,products:null,detail:null,stock:""}},onLoad:function(e){console.log(e),r=this,c=e.id,r.user.rights&&r.user.rights.othercurrent&&(r.othercurrent=r.user.rights.othercurrent),r.getdetail(c)},onShow:function(){r.stock=e.getStorageSync("warehouse")?e.getStorageSync("warehouse")[0].stock:""},onShareAppMessage:function(e){return"button"===e.from&&console.log(e.target),{title:"高明燃气库存管理-操作单详情",path:"/pages/report/EnteringHistory/detail/detail?id="+c}},methods:{gotoexpressDet:function(){e.navigateTo({url:"../expressDet/expressDet?number="+r.detail.expressNum})},priview:function(t){e.previewImage({current:t,urls:r.detail.Images})},show_options:function(){var t=["审核","撤销"];e.showActionSheet({itemList:t,success:function(e){0==e.tapIndex?r.confrimCount():1==e.tapIndex&&r.revoke()},fail:function(e){console.log(e.errMsg)}})},confrimCount:function(){if(r.detail.status)e.showToast({icon:"none",title:"已经审核过了"});else{var t=n.default.Pointer("_User"),o=t.set(e.getStorageSync("user").objectId),i=n.default.Query("order_opreations");i.set("id",r.detail.objectId),i.set("status",!0),i.set("checker",o),i.save().then(function(t){for(var o=r.detail.opreatioGoods,i=function(t){var i=Number(o[t].num),c=n.default.Query("NGoods");c.get(o[t].objectId).then(function(c){c.set("reserve",i),c.save();var u=n.default.Query("NGoods");u.equalTo("header","==",o[t].header.objectId),u.equalTo("order","==",1),u.statTo("sum","reserve"),u.find().then(function(i){var c=i[0]._sumReserve,u=n.default.Query("NGoods");u.get(o[t].header.objectId).then(function(i){if(i.set("reserve",c),i.set("stocktype",c>o[t].warning_num?1:0),i.save(),t==o.length-1){s.default.log(e.getStorageSync("user").nickName+"盘点了'"+o[0].goodsName+"'等"+o.length+"商品",3,r.detail.objectId),console.log(r.bills);var u=n.default.Query("NBills");u.containedIn("objectId",r.bills),u.find().then(function(t){t.set("status",!0),t.saveAll().then(function(t){e.hideLoading(),r.getdetail(r.detail.objectId),setTimeout(function(){e.showToast({icon:"none",title:"盘点单审核成功"})},1e3)}).catch(function(e){console.log(e)})})}})})})},c=0;c<o.length;c++)i(c)})}},getdetail:function(e){var t=n.default.Query("order_opreations");t.include("opreater","custom","producer","stock","checker"),t.get(e).then(function(e){console.log(e),r.detail=e,r.products=e.detail,r.bills=e.bills,r.loading=!1}).catch(function(e){console.log(e)})},revoke:function(){wx.showModal({title:"提示",content:"数据撤销后不可恢复，请谨慎撤销！",success:function(t){if(t.confirm)if(0==r.detail.status){e.showLoading({title:"撤销中..."});var o=n.default.Query("order_opreations");o.destroy(r.detail.objectId).then(function(t){var o=n.default.Query("NBills");o.containedIn("objectId",r.bills),o.find().then(function(t){t.destroyAll().then(function(t){if(3!=r.detail.type)for(var o=0;o<r.products.length;o++)r.delete_bill(o);else e.hideLoading(),e.navigateBack({delta:1}),setTimeout(function(){e.showToast({title:"撤销成功"})},1e3)}).catch(function(e){console.log(e)})})}).catch(function(e){console.log(e)})}else e.showToast({icon:"none",title:"审核成功后，暂不支持撤销"})}})},confrimOrder:function(){wx.showModal({title:"提示",content:"确定进行此操作！",success:function(t){if(t.confirm){e.showLoading({title:"操作中，请勿退出该页面..."});var o=n.default.Pointer("stocks"),s=o.set(r.stock.objectId),i=n.default.Query("order_opreations");i.set("id",c),i.set("stock",s),i.set("status",!0),i.save().then(function(e){var t=0;if(1==r.detail.type){var o=!0,n=!1,s=void 0;try{for(var i,c=r.products[Symbol.iterator]();!(o=(i=c.next()).done);o=!0){var u=i.value;r.addOrReduceGoodReserve(u,t),t+=1}}catch(v){n=!0,s=v}finally{try{o||null==c.return||c.return()}finally{if(n)throw s}}}else if(-1==r.detail.type){var a=!0,l=!1,d=void 0;try{for(var f,h=r.products[Symbol.iterator]();!(a=(f=h.next()).done);a=!0){var g=f.value;r.ReduceGoodReserve(g,t),t+=1}}catch(v){l=!0,d=v}finally{try{a||null==h.return||h.return()}finally{if(l)throw d}}}}).catch(function(e){console.log(e)})}}})},addOrReduceGoodReserve:function(t,o){var i=n.default.Query("NGoods");i.get(t.goodsId.objectId).then(function(i){console.log("当前主产品",i);var u=i;i.set("reserve",i.reserve+t.num),i.save().then(function(i){var a=n.default.Query("NGoods");a.equalTo("userId","==",l),a.equalTo("header","==",t.goodsId.objectId),a.equalTo("stocks","==",r.stock.objectId),a.find().then(function(i){if(console.log("仓库里的产品",i),0==i.length)t.objectId=t.goodsId.objectId,t.costPrice=u.costPrice,t.retailPrice=u.retailPrice,s.default.upload_good_withNoCan(t,r.stock,Number(t.num)).then(function(t){if(console.log(t),o==r.products.length-1){var s=n.default.Pointer("stocks"),i=s.set(r.stock.objectId),u=n.default.Query("NBills");u.containedIn("objectId",r.bills),u.find().then(function(t){t.set("status",!0),t.set("stock",i),t.saveAll().then(function(t){e.hideLoading(),r.getdetail(c),setTimeout(function(){e.showToast({title:"采购入库成功"})},1e3)}).catch(function(e){console.log(e)})})}});else{var a=n.default.Query("NGoods");a.get(i[0].objectId).then(function(s){s.set("reserve",s.reserve+t.num),s.save().then(function(t){var s=n.default.Pointer("stocks"),i=s.set(r.stock.objectId);if(o==r.products.length-1){var u=n.default.Query("NBills");u.containedIn("objectId",r.bills),u.find().then(function(t){t.set("status",!0),t.set("stock",i),t.saveAll().then(function(t){e.hideLoading(),r.getdetail(c),setTimeout(function(){e.showToast({title:"采购入库成功"})},1e3)}).catch(function(e){console.log(e)})})}})})}})})})},ReduceGoodReserve:function(t,o){var i=n.default.Query("NGoods");i.get(t.goodsId.objectId).then(function(i){console.log("当前主产品",i),i.set("reserve",i.reserve-t.num),i.save().then(function(i){var u=n.default.Query("NGoods");u.equalTo("userId","==",l),u.equalTo("header","==",t.goodsId.objectId),u.equalTo("stocks","==",r.stock.objectId),u.find().then(function(i){if(console.log("仓库里的产品",i),0==i.length)t.objectId=t.goodsId.objectId,t.costPrice=headerGood.costPrice,t.retailPrice=headerGood.retailPrice,s.default.upload_good_withNoCan(t,r.stock,0-Number(t.num)).then(function(t){if(console.log(t),o==r.products.length-1){var s=n.default.Pointer("stocks"),i=s.set(r.stock.objectId),u=n.default.Query("NBills");u.containedIn("objectId",r.bills),u.find().then(function(t){t.set("status",!0),t.set("stock",i),t.saveAll().then(function(t){e.hideLoading(),r.getdetail(c),setTimeout(function(){e.showToast({title:"销售出库成功"})},1e3)}).catch(function(e){console.log(e)})})}});else{var u=n.default.Query("NGoods");u.get(i[0].objectId).then(function(s){s.set("reserve",s.reserve-t.num),s.save().then(function(t){if(o==r.products.length-1){var s=n.default.Pointer("stocks"),i=s.set(r.stock.objectId),u=n.default.Query("NBills");u.containedIn("objectId",r.bills),u.find().then(function(t){t.set("status",!0),t.set("stock",i),t.saveAll().then(function(t){e.hideLoading(),r.getdetail(c),setTimeout(function(){e.showToast({title:"销售出库成功"})},1e3)}).catch(function(e){console.log(e)})})}})})}})})})},delete_bill:function(t){var o=r.products[t],s=(r.bills[t],n.default.Query("NGoods"));s.set("id",o.goodsId.objectId),1==o.type?s.set("reserve",o.goodsId.reserve-o.num):-1==o.type&&s.set("reserve",o.goodsId.reserve+o.num),s.save().then(function(o){t==r.products.length-1&&(e.hideLoading(),e.navigateBack({delta:1}),setTimeout(function(){e.showToast({title:"撤销成功"})},1e3))})}}};t.default=d}).call(this,o("543d")["default"])},"4e89":function(e,t,o){"use strict";o.r(t);var n=o("4d40"),s=o.n(n);for(var i in n)"default"!==i&&function(e){o.d(t,e,function(){return n[e]})}(i);t["default"]=s.a},"946f":function(e,t,o){"use strict";var n,s=function(){var e=this,t=e.$createElement;e._self._c},i=[];o.d(t,"b",function(){return s}),o.d(t,"c",function(){return i}),o.d(t,"a",function(){return n})},b05a:function(e,t,o){"use strict";var n=o("3654"),s=o.n(n);s.a}},[["05625","common/runtime","common/vendor"]]]);